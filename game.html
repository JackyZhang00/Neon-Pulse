<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Neon Pulse - Enhanced</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* --- å¼€å±ç•Œé¢æ ·å¼ --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .splash-grid {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 10s linear infinite;
            pointer-events: none;
        }

        @keyframes grid-move { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(50px); } }

        .kanban-container {
            position: absolute; bottom: 0; right: 10%; height: 85%; width: auto;
            pointer-events: none;
            animation: breathe 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3));
            transition: filter 0.3s;
        }

        .kanban-img {
            height: 100%; width: auto; object-fit: contain;
            content: url('nana/cover.png'); 
            mask-image: linear-gradient(to top, transparent 0%, black 20%);
            -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%);
        }
        
        @keyframes breathe { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-10px) scale(1.01); } }

        .speech-bubble {
            position: absolute; bottom: 85%; right: 25%;
            background: rgba(255, 255, 255, 0.9); color: #000;
            padding: 15px 25px; border-radius: 20px 20px 0 20px;
            font-weight: bold; font-size: 18px;
            box-shadow: 0 0 15px #0ff;
            opacity: 0; transform: translateY(20px);
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards 0.5s;
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -10px; right: 0;
            border-width: 10px 10px 0 0; border-style: solid;
            border-color: rgba(255, 255, 255, 0.9) transparent transparent transparent;
        }

        .splash-content {
            z-index: 2; text-align: center; position: relative;
            margin-right: 20%; 
        }

        .splash-title {
            font-size: 100px; font-weight: 900; color: #fff;
            text-transform: uppercase; font-style: italic;
            text-shadow: 4px 4px 0px #f05, -4px -4px 0px #0ff;
            letter-spacing: -5px; margin: 0;
            animation: glitch-skew 3s infinite linear alternate-reverse;
        }

        .splash-subtitle {
            font-size: 24px; color: #0ff; letter-spacing: 10px;
            margin-bottom: 50px; text-shadow: 0 0 10px #0ff;
        }

        .click-hint {
            font-size: 20px; color: #aaa; border: 1px solid #555;
            padding: 10px 30px; border-radius: 30px;
            background: rgba(0,0,0,0.5); cursor: pointer;
            transition: all 0.2s; animation: pulse-opacity 1.5s infinite;
        }
        .click-hint:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }

        @keyframes pulse-opacity { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes pop-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes glitch-skew {
            0% { transform: skew(0deg); }
            20% { transform: skew(0deg); }
            22% { transform: skew(10deg); }
            24% { transform: skew(-10deg); }
            26% { transform: skew(0deg); }
            100% { transform: skew(0deg); }
        }

        /* --- æ¸¸æˆåŸºç¡€æ ·å¼ --- */
        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0.3; filter: blur(8px) brightness(0.5); z-index: 0;
            transition: all 0.1s ease;
        }

        canvas { display: block; position: relative; z-index: 1; }
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10;
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #countdown-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30; background: rgba(0,0,0,0.3);
            font-size: 150px; font-weight: 900; color: #fff;
            text-shadow: 0 0 30px #0ff;
            align-items: center; justify-content: center;
        }

        #loading-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; background: rgba(0,0,0,0.9);
            flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #0ff;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #hud { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: none; }
        #score-display { position: absolute; top: 20px; left: 20px; font-size: 40px; font-weight: 900; }
        
        #auto-indicator {
            position: absolute; top: 65px; left: 24px; 
            font-size: 14px; color: #00ccff; font-weight: bold; letter-spacing: 2px;
            border: 1px solid #00ccff; padding: 2px 6px; border-radius: 4px;
            display: none; box-shadow: 0 0 10px rgba(0,204,255,0.3);
        }

        /* --- æ¸¸æˆå†…ç«‹ç»˜æ ·å¼ (New) --- */
        #character-display {
            position: absolute; bottom: 0; left: 0;
            height: 78%; width: auto; max-width: 32%;
            pointer-events: none; z-index: 4;
            display: flex; align-items: flex-end;
            filter: drop-shadow(0 0 15px rgba(0,255,255,0.2));
            transition: all 0.5s ease;
        }
        #ingame-char-img {
            height: 100%; width: auto; object-fit: contain;
            mask-image: linear-gradient(to top, transparent 0%, black 15%);
            -webkit-mask-image: linear-gradient(to top, transparent 0%, black 15%);
            transition: transform 0.1s;
        }

        #combo-display { position: absolute; top: 90px; left: 20px; font-size: 30px; color: #ffcc00; font-weight: bold; opacity: 0; transition: transform 0.1s; }
        #song-info-hud { position: absolute; top: 20px; right: 20px; text-align: right; }
        
        /* --- åˆ†æ•°æ¡æ ·å¼ --- */
        #score-bar-container {
            position: absolute; right: 30px; top: 100px; bottom: 50px; width: 15px;
            background: rgba(20, 20, 20, 0.6); border: 1px solid #444; border-radius: 8px;
            overflow: visible;
        }
        #score-bar-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: linear-gradient(to top, #00ccff, #00ffaa);
            border-radius: 8px;
            transition: height 0.1s linear, background 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        @keyframes rainbow-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes bar-pulse {
            0% { box-shadow: 0 0 15px #ff0055, 0 0 30px rgba(255, 0, 85, 0.5); }
            50% { box-shadow: 0 0 25px #ff0055, 0 0 50px rgba(255, 200, 0, 0.8); }
            100% { box-shadow: 0 0 15px #ff0055, 0 0 30px rgba(255, 0, 85, 0.5); }
        }

        .score-bar-cleared {
            background: linear-gradient(0deg, #ff0055, #ffcc00, #00ffaa, #00ccff, #d600ff, #ff0055) !important;
            background-size: 100% 400% !important;
            animation: rainbow-flow 3s linear infinite, bar-pulse 1s ease-in-out infinite !important;
            border: 1px solid rgba(255,255,255,0.8);
        }

        #score-bar-marker {
            position: absolute; left: -5px; width: 25px; height: 2px;
            background: #aaa; z-index: 10;
            box-shadow: 0 0 5px #fff;
            transition: background 0.3s;
        }
        #score-bar-marker.marker-passed {
            background: #fff; box-shadow: 0 0 10px #ff0055;
        }
        #score-bar-marker::after {
            content: "CLEAR"; position: absolute; right: 30px; top: -10px;
            font-size: 10px; color: #aaa; font-weight: bold; font-family: monospace;
            transition: color 0.3s;
        }
        #score-bar-marker.marker-passed::after { color: #fff; text-shadow: 0 0 5px #ff0055; }
        
        /* --- ç»“ç®—å°ç« æ ·å¼ --- */
        .stamp-normal {
            font-size: 30px; font-weight: bold; 
            border: 3px solid currentColor; display: inline-block; padding: 5px 15px; 
            transform: rotate(-10deg);
        }
        .stamp-critical {
            font-size: 50px; font-weight: 900; font-family: 'Segoe UI', sans-serif;
            padding: 10px 40px; border: 5px solid rgba(255,255,255,0.8); border-radius: 12px;
            text-transform: uppercase; display: inline-block;
            background: linear-gradient(to right, #ff0000, #ff8800, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: stamp-shine 2s linear infinite, stamp-pulse 0.8s ease-in-out infinite alternate, stamp-rotate-wobble 3s ease-in-out infinite;
        }
        .stamp-auto {
            font-size: 40px; font-weight: bold; 
            border: 4px solid #00ccff; color: #00ccff;
            display: inline-block; padding: 10px 30px; 
            transform: rotate(-5deg); letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,204,255,0.5);
            box-shadow: 0 0 15px rgba(0,204,255,0.3), inset 0 0 15px rgba(0,204,255,0.3);
        }

        @keyframes stamp-shine { to { background-position: 200% center; } }
        @keyframes stamp-pulse {
            from { box-shadow: 0 0 20px rgba(255,0,0,0.5), inset 0 0 10px rgba(255,0,0,0.5); border-color: #ff0055; transform: rotate(-10deg) scale(1); }
            to { box-shadow: 0 0 50px rgba(0,255,255,0.8), inset 0 0 30px rgba(0,255,255,0.5); border-color: #00ccff; transform: rotate(-10deg) scale(1.1); }
        }
        @keyframes stamp-rotate-wobble {
            0%, 100% { transform: rotate(-10deg) scale(1); }
            50% { transform: rotate(-12deg) scale(1.05); }
        }

        /* --- é€‰æ­Œç•Œé¢ --- */
        #song-select-screen { display: flex; flex-direction: column; padding: 30px; box-sizing: border-box; }
        #category-bar { height: 50px; display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tag-btn { padding: 5px 15px; border-radius: 20px; border: 1px solid #666; background: transparent; color: #aaa; cursor: pointer; white-space: nowrap; }
        .tag-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: bold; }
        
        .content-wrapper { display: flex; flex: 1; overflow: hidden; gap: 40px; width: 100%; }
        .song-list-panel { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 10px; border-right: 1px solid #333; }
        .song-item { padding: 15px; background: rgba(255,255,255,0.05); cursor: pointer; border-left: 4px solid transparent; border-radius: 4px; }
        .song-item.selected { background: linear-gradient(90deg, rgba(0,255,255,0.2), transparent); border-left: 4px solid #0ff; }
        .song-info-panel { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cover-art { width: 300px; height: 300px; object-fit: cover; border-radius: 8px; border: 2px solid #555; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        .diff-selector { display: flex; gap: 10px; margin: 20px 0; }
        .diff-btn { padding: 8px 20px; border: 1px solid #666; background: transparent; color: #888; cursor: pointer; border-radius: 20px; font-weight: bold; transition: all 0.2s; }
        .diff-btn.disabled { opacity: 0.2; cursor: not-allowed; border-color: #333; background: #111; color: #444; pointer-events: none; }
        
        .diff-btn[data-diff="easy"].active { background: #00ccff; border-color: #00ccff; box-shadow: 0 0 15px #00ccff; color: #000; }
        .diff-btn[data-diff="normal"].active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 15px #00ff00; color: #000; }
        .diff-btn[data-diff="hard"].active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; color: #000; }
        .diff-btn[data-diff="expert"].active { background: #ff0000; border-color: #ff0000; box-shadow: 0 0 15px #ff0000; color: #fff; }

        .main-btn { padding: 15px 50px; font-size: 20px; background: #fff; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 15px; }
        .main-btn:hover { background: #0ff; transform: scale(1.05); }

        /* --- å†å²æœ€ä½³æˆç»©å±•ç¤ºæ ·å¼ --- */
        #best-record-box {
            background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px;
            padding: 10px 25px; margin: 10px 0;
            display: flex; flex-direction: column; align-items: center;
            min-width: 200px;
        }
        .record-label { font-size: 12px; color: #888; letter-spacing: 2px; margin-bottom: 2px; }
        .record-val { font-size: 24px; font-weight: 900; font-family: monospace; color: #fff; text-shadow: 0 0 5px #fff; }
        .record-badge { 
            font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; margin-top: 5px; 
            letter-spacing: 1px;
        }
        .badge-none { display: none; }
        .badge-clear { border: 1px solid #aaa; color: #aaa; }
        .badge-fc { border: 1px solid #ffcc00; color: #ffcc00; background: rgba(255, 204, 0, 0.1); box-shadow: 0 0 10px rgba(255,204,0,0.2); }
        .badge-ap { border: 1px solid #00ccff; color: #00ccff; background: rgba(0, 204, 255, 0.1); box-shadow: 0 0 10px rgba(0,204,255,0.2); }
        .badge-ac { 
            border: 1px solid #d600ff; 
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        /* --- è®¾ç½®èœå•æ ·å¼ --- */
        #settings-btn {
            position: absolute; top: 30px; right: 30px; z-index: 20;
            background: transparent; border: 1px solid #666; color: #aaa;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-weight: bold; transition: all 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        #settings-btn:hover { border-color: #0ff; color: #0ff; background: rgba(0,255,255,0.1); }

        /* --- SETTINGS TABS (NEW) --- */
        .settings-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 0 0 20px 0;
            flex-wrap: wrap;
        }
        .settings-tab {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 900;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .settings-tab:hover {
            border-color: #0ff;
            color: #0ff;
            background: rgba(0,255,255,0.08);
        }
        .settings-tab.active {
            border-color: #0ff;
            color: #000;
            background: #0ff;
        }

        .settings-section {
            display: none;
        }
        .settings-section.active {
            display: block;
        }

        .settings-section .setting-group-title {
            margin-top: 10px;
        }

        #mailbox-btn {
            position: absolute; top: 30px; right: 160px; z-index: 20;
            background: transparent; border: 1px solid #666; color: #aaa;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-weight: bold; transition: all 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        #mailbox-btn:hover { border-color: #f05; color: #f05; background: rgba(255,0,85,0.1); }
        .badge-notification {
            width: 10px; height: 10px; background: #f05; border-radius: 50%;
            position: absolute; top: 0; right: 0; box-shadow: 0 0 5px #f05;
            display: none; animation: pulse-badge 1s infinite;
        }

        #collection-btn { position: absolute; top: 30px; right: 290px; z-index: 20; background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        #collection-btn:hover { border-color: #aa00ff; color: #aa00ff; background: rgba(170, 0, 255, 0.1); }

        #main-fragment-display {
            position: absolute; top: 80px; right: 30px; z-index: 20;
            color: #ccc; font-family: monospace; font-size: 16px;
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border: 1px solid #333;
            display: flex; align-items: center; gap: 8px;
        }
        .fragment-icon { width: 15px; height: 15px; background: linear-gradient(45deg, #0ff, #f05); transform: rotate(45deg); display: inline-block; box-shadow: 0 0 5px #0ff; }

        #settings-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 80; backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }

        .settings-panel {
            background: #1a1a1a; padding: 40px; border-radius: 12px; border: 1px solid #444;
            width: 450px; max-width: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .settings-header {
            font-size: 24px; font-weight: 900; color: #fff; border-bottom: 1px solid #333;
            padding-bottom: 15px; margin-bottom: 20px; text-align: center; letter-spacing: 2px;
        }

        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 16px; color: #ccc; }
        .setting-row input[type="range"] { flex: 1; margin: 0 15px; accent-color: #0ff; }
        .setting-row select, .setting-row input[type="number"] { background: #333; border: 1px solid #555; color: white; padding: 5px 10px; border-radius: 4px; font-family: inherit; }
        .setting-row input[type="checkbox"] { width: 24px; height: 24px; cursor: pointer; accent-color: #0ff; }
        .setting-group-title { color: #0ff; font-size: 14px; font-weight: bold; margin-top: 20px; margin-bottom: 10px; border-left: 3px solid #0ff; padding-left: 10px; }

        /* --- ç»“ç®—ç•Œé¢ --- */
        #result-card { background: #222; padding: 40px; border-radius: 12px; border: 1px solid #444; text-align: center; min-width: 500px; position: relative; }
        .grade-big { font-size: 100px; font-weight: 900; margin: 10px 0; }
        .failed-text { color: #f05; font-size: 30px; font-weight: bold; margin-top: 10px; display: none; }
        
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px;
            margin: 20px 0; text-align: left; font-family: monospace; font-size: 18px;
        }
        .stat-row { display: flex; justify-content: space-between; }
        .stat-label { color: #aaa; }
        .stat-val { font-weight: bold; }

        .new-record-badge {
            position: absolute;
            top: 20%; right: -25px;
            transform: rotate(15deg);
            font-size: 20px; font-weight: 900; color: #fff700;
            background: linear-gradient(45deg, #ff0055, #ff5500);
            padding: 8px 20px;
            border: 2px solid #fff; border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 247, 0, 0.6);
            animation: pulse-badge 0.6s infinite alternate;
            z-index: 20; display: none;
            letter-spacing: 2px;
        }
        @keyframes pulse-badge {
            from { transform: rotate(15deg) scale(1); box-shadow: 0 0 20px rgba(255, 247, 0, 0.6); }
            to { transform: rotate(15deg) scale(1.1); box-shadow: 0 0 40px rgba(255, 247, 0, 1); }
        }

        /* æŠ€èƒ½è§¦å‘æç¤ºæ–‡å­— */
        #skill-trigger-text {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; font-weight: 900; color: #fff; text-shadow: 0 0 20px #f05;
            opacity: 0; pointer-events: none; z-index: 100; font-style: italic;
        }
        @keyframes skill-pop { 0% { opacity: 0; transform: translate(-50%, -40%) scale(0.8); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -60%); } }
        
        /* --- æ›´æ–°æ—¥å¿— --- */
        #update-box {
            background: #1a1a1a; padding: 40px; border-radius: 12px; border: 1px solid #0ff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.15); max-width: 600px; width: 85%; color: #eee;
        }
        .update-header { text-align: center; font-size: 24px; font-weight: 900; color: #0ff; margin-bottom: 20px; }
        .update-content { margin-bottom: 30px; font-size: 16px; max-height: 300px; overflow-y: auto; }
        .update-tag { display: inline-block; background: rgba(0, 255, 255, 0.2); color: #0ff; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px; font-weight: bold; }
        .update-list-item { margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* --- æ ¡å‡†ç•Œé¢ --- */
        #calibration-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 60; flex-direction: column; align-items: center; justify-content: center; user-select: none;
        }
        .calib-visual-beat {
            width: 100px; height: 100px; background: #333; border-radius: 50%;
            box-shadow: 0 0 0px #333; transition: transform 0.1s, background 0.1s, box-shadow 0.1s;
            margin-bottom: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 30px; font-weight: bold; color: rgba(255,255,255,0.2);
        }
        .calib-visual-beat.beat-active { transform: scale(1.2); background: #fff; box-shadow: 0 0 30px #fff; }
        .calib-visual-beat.tap-feedback { border: 2px solid #0ff; background: transparent; color: #0ff; }
        .calib-progress { width: 300px; height: 4px; background: #333; margin: 20px 0; border-radius: 2px; }
        .calib-progress-bar { height: 100%; background: #0ff; width: 0%; transition: width 0.2s; box-shadow: 0 0 10px #0ff; }
        .calib-instruction { color: #888; margin-bottom: 20px; text-align: center; line-height: 1.6; }
        .calib-result-text { font-size: 24px; color: #0ff; font-weight: bold; margin-top: 10px; }

        /* æ”¶ä»¶ç®±ç•Œé¢æ ·å¼ */
        #mailbox-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 90; backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .mailbox-panel {
            background: #111; border: 1px solid #444; width: 800px; height: 500px;
            display: flex; border-radius: 8px; box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }
        .mail-list {
            width: 300px; background: #1a1a1a; border-right: 1px solid #333;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .mail-item {
            padding: 15px; border-bottom: 1px solid #333; cursor: pointer;
            transition: background 0.2s; position: relative;
        }
        .mail-item:hover { background: #222; }
        .mail-item.active { background: #2a2a2a; border-left: 3px solid #f05; }
        .mail-item-title { font-weight: bold; margin-bottom: 5px; color: #eee; }
        .mail-item-sender { font-size: 12px; color: #888; }
        .mail-item.unread::after {
            content: 'NEW'; position: absolute; top: 15px; right: 15px;
            background: #f05; color: #fff; font-size: 10px; padding: 2px 5px;
            border-radius: 4px; font-weight: bold;
        }
        .mail-content-area {
            flex: 1; padding: 30px; display: flex; flex-direction: column; position: relative;
            background: 
                radial-gradient(circle at top right, rgba(255,0,85,0.05) 0%, transparent 40%),
                linear-gradient(to bottom, #111 0%, #0d0d0d 100%);
        }
        .mail-detail-header { border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .mail-detail-title { font-size: 28px; font-weight: 900; color: #fff; margin-bottom: 10px; }
        .mail-detail-meta { color: #666; font-size: 14px; display: flex; justify-content: space-between; }
        .mail-body {
            font-size: 16px; line-height: 1.6; color: #ccc; white-space: pre-wrap; flex: 1; overflow-y: auto;
        }
        .btn-close-mail {
            position: absolute; top: 10px; right: 10px; background: transparent; border: none;
            color: #666; font-size: 24px; cursor: pointer;
        }
        .btn-close-mail:hover { color: #fff; }

        /* æ”¶è—ç³»ç»Ÿ (Collection) æ ·å¼ */
        #collection-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 85; backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .collection-panel {
            width: 900px; height: 600px; background: #161616; border: 1px solid #333;
            display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 0 50px rgba(170, 0, 255, 0.15);
        }
        .collection-header {
            height: 60px; border-bottom: 1px solid #333; display: flex; align-items: center;
            padding: 0 30px; justify-content: space-between; background: #1a1a1a;
        }
        .collection-title { font-size: 22px; font-weight: 900; color: #aa00ff; letter-spacing: 2px; }
        .collection-tabs { display: flex; gap: 20px; }
        .col-tab {
            background: transparent; border: none; color: #666; font-size: 16px; font-weight: bold; cursor: pointer;
            padding: 5px 0; border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .col-tab:hover { color: #fff; }
        .col-tab.active { color: #fff; border-bottom-color: #aa00ff; }
        .collection-content { flex: 1; display: flex; overflow: hidden; }
        .collection-list { width: 350px; border-right: 1px solid #333; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: 1fr; gap: 10px; align-content: start; }
        .collection-detail { flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, rgba(170,0,255,0.05), transparent 70%); }
        
        .col-item-card {
            background: #222; padding: 15px; border-radius: 6px; cursor: pointer; border: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .col-item-card:hover { background: #2a2a2a; border-color: #555; }
        .col-item-card.active { border-color: #aa00ff; background: rgba(170,0,255,0.1); }
        .col-item-card.locked { opacity: 0.6; }
        .lock-icon { font-size: 12px; background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; }
        .col-item-info h4 { margin: 0 0 5px 0; font-size: 16px; color: #eee; }
        .col-item-info p { margin: 0; font-size: 12px; color: #888; }
        
        .detail-placeholder { color: #555; font-size: 18px; letter-spacing: 1px; }
        .detail-view { width: 100%; height: 100%; display: flex; flex-direction: column; text-align: left; }
        .detail-image { 
            max-width: 100%; max-height: 300px; object-fit: contain; 
            margin-bottom: 20px; border: 2px solid #333; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: zoom-in; 
            transition: transform 0.2s;
        }
        .detail-image:hover { transform: scale(1.02); border-color: #aa00ff; }
        .detail-title { font-size: 28px; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .detail-text { font-size: 16px; line-height: 1.8; color: #ccc; white-space: pre-wrap; overflow-y: auto; max-height: 350px; padding-right: 10px; }
        
        .unlock-area { text-align: center; margin-top: auto; padding-top: 20px; border-top: 1px solid #333; width: 100%; }
        .unlock-btn {
            background: linear-gradient(45deg, #aa00ff, #ff00cc); border: none; padding: 10px 40px;
            color: #fff; font-weight: bold; font-size: 16px; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 15px rgba(170,0,255,0.4); transition: transform 0.2s;
        }
        .unlock-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(170,0,255,0.6); }
        .unlock-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .frag-cost { color: #aa00ff; font-weight: bold; margin-bottom: 10px; display: block; }

 /* --- å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨æ ·å¼ (New) --- */
        #image-viewer-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            align-items: center; justify-content: center; flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ”¾å¤§åå‡ºç°æ»šåŠ¨æ¡ */
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
        }
        .viewer-img {
            max-width: 90%; max-height: 80%; object-fit: contain;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            cursor: grab;
            transform-origin: center center; /* ä»ä¸­å¿ƒç¼©æ”¾ */
            will-change: transform; /* æ€§èƒ½ä¼˜åŒ– */
        }
        .viewer-img:active { cursor: grabbing; }
        
        .viewer-controls {
            position: absolute; bottom: 30px; /* å›ºå®šåœ¨åº•éƒ¨ï¼Œä¸éšå›¾ç‰‡ç§»åŠ¨ */
            display: flex; gap: 20px; z-index: 201;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ°ä¸‹æ–¹ï¼Œé¿å…è¯¯è§¦ */
        }
        .viewer-btn {
            background: #222; border: 1px solid #555; color: #eee;
            padding: 10px 20px; border-radius: 30px; cursor: pointer;
            font-weight: bold; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
            pointer-events: auto; /* æ¢å¤æŒ‰é’®ç‚¹å‡» */
        }
        .viewer-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .close-viewer-btn {
            position: absolute; top: 30px; right: 30px; font-size: 30px;
            background: transparent; border: none; color: #666; cursor: pointer; z-index: 202;
        }
        .close-viewer-btn:hover { color: #fff; transform: scale(1.1); }

        /* å¼ºåˆ¶è®©ç»“ç®—ç•Œé¢çš„èƒŒæ™¯é€æ˜ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°ä¸‹æ–¹çš„ Canvas */
        #result-screen {
            background: transparent !important; 
        }

        /* ç¡®ä¿ç»“æœå¡ç‰‡ä¾ç„¶æœ‰èƒŒæ™¯ï¼Œä¸ç„¶æ–‡å­—çœ‹ä¸æ¸… */
        #result-card {
            z-index: 20; /* ä¿è¯å¡ç‰‡æµ®åœ¨çƒŸèŠ±ä¸Šé¢ */
            position: relative;
        }

    </style>
</head>
<body>

<div id="splash-screen" onclick="enterGame()">
    <div class="splash-grid"></div>
    <div class="kanban-container">
        <img class="kanban-img" src="nana/cover.png" alt="Kanban">
    </div>
    <div class="speech-bubble">åŒæ­¥ä¿¡å·æ¥é€šï¼ä½ ç»ˆäºæ¥å•¦ï¼ä»Šå¤©ä¹Ÿè¦ä¸€èµ·æŠŠèŠ‚å¥ç‚¹ç‡ƒå—ï¼Ÿâœ¨</div>
    <div class="splash-content">
        <h1 class="splash-title">NEON PULSE</h1>
        <div class="splash-subtitle">CYBER RHYTHM ACTION</div>
        <div class="click-hint">>> CLICK TO START <<</div>
    </div>
</div>

<div id="bg-layer"></div>
<div id="progress-bar" style="position:absolute; top:0; left:0; height:5px; background:#0ff; z-index:20; width:0%;"></div>

<div id="countdown-overlay" style="display:none;">5</div>

<div id="loading-overlay">
    <div class="loading-spinner"></div>
    <div style="font-size: 20px; letter-spacing: 2px; font-weight: bold;">LOADING DATA...</div>
    <div id="loading-text" style="margin-top:10px; color:#888; font-size:14px;">Please wait</div>
</div>

<div id="calibration-overlay">
    <h2 style="color:#fff; letter-spacing:4px; margin-bottom:10px;">AUDIO SYNC</h2>
    <div class="calib-instruction" id="calib-step-1">
        è¯·è·ŸéšèŠ‚å¥ï¼Œåœ¨å¬åˆ° <strong>é‡éŸ³</strong> æ—¶æŒ‰ä¸‹ç©ºæ ¼æˆ–ç‚¹å‡»å±å¹•ã€‚<br>
        å…±éœ€æ•²å‡» 8 æ¬¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å»¶è¿Ÿã€‚
    </div>
    <div id="calib-beat-circle" class="calib-visual-beat">â™ª</div>
    <div class="calib-progress"><div id="calib-progress-bar" class="calib-progress-bar"></div></div>
    <div id="calib-status" style="color:#aaa; font-family:monospace;">Waiting...</div>
    <div id="calib-result" class="calib-result-text" style="display:none;">0 ms</div>
    <div style="margin-top:40px; display:flex; gap:20px;">
        <button class="main-btn" onclick="stopCalibration()" style="padding:10px 30px; font-size:16px; background:#333; color:#aaa;">CANCEL</button>
        <button id="calib-apply-btn" class="main-btn" onclick="applyCalibration()" style="padding:10px 30px; font-size:16px; display:none;">APPLY & SAVE</button>
    </div>
</div>

<div id="hud">
    <!-- ç«‹ç»˜å®¹å™¨ -->
    <div id="character-display">
        <img id="ingame-char-img" src="" alt="Character">
    </div>

    <div id="score-display">0000000</div>
    <div id="auto-indicator">[ AUTOMATION ACTIVE ]</div>
    <div id="combo-display">COMBO 0</div>
    <div id="song-info-hud">
        <div id="hud-title" style="font-weight:bold; font-size:20px;">Title</div>
        <div id="hud-detail" style="color:#aaa;">Artist</div>
    </div>
    
    <div id="score-bar-container">
        <div id="score-bar-fill"></div>
        <div id="score-bar-marker"></div>
    </div>

    <button onclick="pauseGame()" style="pointer-events:auto; position:absolute; top:20px; left:50%; transform:translateX(-50%); background:transparent; border:1px solid #fff; color:#fff; padding:5px 15px; cursor:pointer;">PAUSE (ESC)</button>
</div>

<!-- æš‚åœèœå• -->
<div id="pause-menu" class="overlay" style="display:none;">
    <h1 style="color:#fff;">PAUSED</h1>
    <button class="main-btn" onclick="startResumeCountdown()">RESUME</button>
    <button class="main-btn" onclick="retryGame()" style="margin-top:20px; background:#00ccff; color:black;">RETRY</button>
    <button class="main-btn" onclick="backToMenu()" style="margin-top:20px; background:#f05; color:white;">EXIT</button>
</div>

<!-- æ”¶ä»¶ç®±å¼¹çª— -->
<div id="mailbox-overlay">
    <div class="mailbox-panel">
        <div class="mail-list" id="mail-list-container">
            <!-- é‚®ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="mail-content-area">
            <button class="btn-close-mail" onclick="closeMailbox()">Ã—</button>
            <div id="mail-detail-view" style="display:none; height:100%; flex-direction:column;">
                <div class="mail-detail-header">
                    <div class="mail-detail-title" id="mail-view-title">Title</div>
                    <div class="mail-detail-meta">
                        <span id="mail-view-sender">From: Sender</span>
                        <span id="mail-view-date">Date</span>
                    </div>
                </div>
                <div class="mail-body" id="mail-view-content">Content...</div>
            </div>
            <div id="mail-empty-state" style="display:flex; height:100%; align-items:center; justify-content:center; color:#444;">
                <div>SELECT A MAIL TO READ</div>
            </div>
        </div>
    </div>
</div>

<!-- æ”¶è—ç³»ç»Ÿå¼¹çª— -->
<div id="collection-overlay">
    <div class="collection-panel">
        <div class="collection-header">
            <div class="collection-title">æ¡£æ¡ˆå®¤ // N-07</div>
            <div class="collection-tabs">
                <button class="col-tab active" onclick="switchCollectionTab('story')">STORY LOGS</button>
                <button class="col-tab" onclick="switchCollectionTab('gallery')">GALLERY</button>
            </div>
            <div style="display:flex; align-items:center; gap:5px; color:#aa00ff; font-weight:bold;">
                <div class="fragment-icon"></div> <span id="col-panel-fragments">0</span>
            </div>
            <button class="btn-close-mail" onclick="closeCollection()" style="font-size: 16px; font-weight: 900; color: #aa00ff; border: 2px solid #aa00ff; padding: 5px 20px; border-radius: 4px; top: 12px; right: 20px; width: auto; letter-spacing: 2px; background: transparent;">
                CLOSE
            </button>
        </div>
        <div class="collection-content">
            <div class="collection-list" id="collection-list-container">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ—è¡¨é¡¹ -->
            </div>
            <div class="collection-detail" id="collection-detail-container">
                <div class="detail-placeholder">SELECT A FILE TO DECRYPT</div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨ (New) -->
<div id="image-viewer-overlay">
    <button class="close-viewer-btn" onclick="closeImageViewer()">Ã—</button>
    <img id="viewer-img" class="viewer-img" src="" alt="Full View">
    <div class="viewer-controls">
        <button class="viewer-btn" onclick="downloadCurrentImage()">
            <span>â¬‡</span> DOWNLOAD
        </button>
        <div style="color:#aaa; display:flex; align-items:center; font-size:12px;">SCROLL TO ZOOM</div>
    </div>
</div>

<div id="settings-overlay">
    <div class="settings-panel">
        <div class="settings-header">SETTINGS</div>

        <!-- Tabs -->
        <div class="settings-tabs">
        <button class="settings-tab active" data-tab="gameplay">GAMEPLAY</button>
        <button class="settings-tab" data-tab="assist">ASSIST</button>
        <button class="settings-tab" data-tab="audio">AUDIO</button>
        <button class="settings-tab" data-tab="other">OTHER</button>
        </div>

        <!-- GAMEPLAY -->
        <div class="settings-section active" data-section="gameplay">
        <div class="setting-group-title">GAMEPLAYï¼ˆæ¸¸æˆï¼‰</div>

        <div class="setting-row">
            <span>Note Speed (æµé€Ÿ)</span>
            <input type="range" id="speed-input" min="1" max="8" step="0.1" value="2.0">
            <span id="speed-val" style="width:35px; text-align:right;">2.0</span>
        </div>

        <div class="setting-row">
            <span>Input Mode (æŒ‰é”®)</span>
            <select id="input-mode-select">
            <option value="arrow">Arrow Keys (â†‘â†’â†“â†)</option>
            <option value="wasd">WASD (W D S A)</option>
            </select>
        </div>

        <div class="setting-row">
            <span>Auto Play (æ¼”ç¤ºæ¨¡å¼)</span>
            <input type="checkbox" id="auto-mode-check">
        </div>

        <div class="setting-row">
            <span>Character (ç«‹ç»˜é€‰æ‹©)</span>
            <select id="character-select" style="width: 150px;"></select>
        </div>
        </div>

        <!-- ASSIST -->
        <div class="settings-section" data-section="assist">
        <div class="setting-group-title">ASSISTï¼ˆè¾…åŠ©è‡ªåŠ¨ï¼‰</div>

        <div class="setting-row">
            <span>ç©ºæ ¼</span>
            <input type="checkbox" id="auto-space-check">
        </div>

        <div class="setting-row">
            <span>æ–¹å‘</span>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <label style="display:flex; gap:4px; align-items:center; color:#aaa;">
                    <input type="checkbox" id="auto-up-check">â†‘ï¼ˆWï¼‰
                </label>
                <label style="display:flex; gap:4px; align-items:center; color:#aaa;">
                    <input type="checkbox" id="auto-right-check">â†’ï¼ˆDï¼‰
                </label>
                <label style="display:flex; gap:4px; align-items:center; color:#aaa;">
                    <input type="checkbox" id="auto-down-check">â†“ï¼ˆSï¼‰
                </label>
                <label style="display:flex; gap:4px; align-items:center; color:#aaa;">
                    <input type="checkbox" id="auto-left-check">â†ï¼ˆAï¼‰
                </label>
            </div>
        </div>
        </div>

        <!-- AUDIO -->
        <div class="settings-section" data-section="audio">
        <div class="setting-group-title">AUDIO & SOUNDï¼ˆéŸ³é¢‘è®¾ç½®ï¼‰</div>

        <div class="setting-row">
            <span>Audio Offset (å»¶è¿Ÿ ms)</span>
            <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" id="offset-input" value="0" style="width:60px;">
            <button onclick="startCalibration()" style="background:#222; border:1px solid #0ff; color:#0ff; cursor:pointer; border-radius:4px; padding:4px 8px; font-size:12px;">
                â™ª CALIBRATE
            </button>
            </div>
        </div>

        <div class="setting-row">
            <span>BGM Volumeï¼ˆéŸ³ä¹éŸ³é‡ï¼‰</span>
            <input type="range" id="bgm-vol-input" min="0" max="1" step="0.01" value="0.8">
            <span id="bgm-vol-val" style="width:45px; text-align:right;">0.80</span>
        </div>

        <div class="setting-row">
            <span>SFX Volumeï¼ˆéŸ³æ•ˆéŸ³é‡ï¼‰</span>
            <input type="range" id="sfx-vol-input" min="0" max="1" step="0.01" value="0.8">
            <span id="sfx-vol-val" style="width:45px; text-align:right;">0.80</span>
        </div>

        <div class="setting-row">
            <span>Hit Sound (æ‰“å‡»éŸ³æ•ˆ)</span>
            <input type="checkbox" id="hitsound-check" checked>
        </div>

        <div class="setting-row">
            <span>Sound Pack (éŸ³æ•ˆ)</span>
            <select id="soundpack-select">
            <option value="loading">Loading...</option>
            </select>
        </div>
        </div>

        <!-- OTHER -->
        <div class="settings-section" data-section="other" style="display: none;">
        <div class="setting-group-title" style="color:#666; border-color:#666;">DEBUG / OTHER</div>

        <div class="setting-row" style="display:none;">
            <span style="color:#888">Developer Mode</span>
            <input type="checkbox" id="dev-mode-check">
        </div>

        <div style="color:#666; font-size:12px; line-height:1.6; margin-top:10px;">
            Tip: ä½¿ç”¨ ASSISTï¼ˆç©ºæ ¼/æ–¹å‘é”®è‡ªåŠ¨ï¼‰ä¼šè¢«è§†ä¸ºè¾…åŠ©æ¨¡å¼ï¼Œé»˜è®¤ä¸è®°å½•æˆç»©ä¸ç¢ç‰‡å¥–åŠ±ã€‚
        </div>
        </div>

        <div style="text-align:center; margin-top:30px;">
        <button class="main-btn" onclick="closeSettings()" style="padding:10px 40px; font-size:16px;">CLOSE</button>
        </div>
    </div>
</div>

<div id="update-modal" class="overlay" style="display:none; z-index: 100;">
    <div id="update-box">
        <div class="update-header">System Update // V1.4.0_alpha</div>
        <div class="update-content">
            <div class="update-list-item"><span class="update-tag">FIX</span><strong>ä¼˜åŒ–</strong><br><span style="color:#aaa;">é€‰é¡¹èœå•å¸ƒå±€</span></div>
            <div class="update-list-item"><span class="update-tag">NEW</span><strong>éŸ³é‡è®¾ç½®</strong><br><span style="color:#aaa;">å¯ä»¥åœ¨é€‰é¡¹èœå•ä¸­è®¾ç½®éŸ³æ•ˆä¸éŸ³ä¹çš„éŸ³é‡å¤§å°</span></div>
            <div class="update-list-item"><span class="update-tag">NEW</span><strong>ç«‹ç»˜ç³»ç»Ÿ</strong><br><span style="color:#aaa;">åœ¨æ¸¸æˆè¿‡ç¨‹ä¸­å¯ä»¥è®¾ç½®N-07ç«‹ç»˜ä¸æ ·å¼</span></div>
            <div class="update-list-item"><span class="update-tag">NEW</span><strong>è¾…åŠ©æ¼”å¥åŠŸèƒ½</strong><br><span style="color:#aaa;">N-07å¯ä»¥åœ¨æ¼”å‡ºè¿‡ç¨‹ä¸­å¸®åŠ©ä½ æ¼”å¥ä¸€äº›éŸ³ç¬¦ï¼ˆä¸çŸ¥é“å¥¹ä¸ºä»€ä¹ˆä¼šè¿™æ ·åšâ€¦â€¦ï¼‰</span></div>
            <div class="update-list-item"><span class="update-tag">NEW</span><strong>æ¡£æ¡ˆå®¤</strong><br><span style="color:#aaa;">ä½ å¯ä»¥æŸ¥çœ‹æ›´å¤šçš„å…³äºN-07çš„èƒŒæ™¯ä¸ç«‹ç»˜ï¼ˆä¹Ÿè®¸ä½ ä¼šå‘ç°ä¸€äº›å¥¹çš„ç»å†ï¼‰</span></div>
        </div>
        <div style="text-align: center;"><button class="main-btn" onclick="closeUpdateModal()">CONFIRM</button></div>
    </div>
</div>

<div id="song-select-screen" class="overlay" style="display: none;">
    <!-- ç¢ç‰‡å±•ç¤º -->
    <div id="main-fragment-display">
        <div class="fragment-icon"></div>
        <span id="fragment-count-display">0</span>
    </div>

    <!-- æ”¶è—æŒ‰é’® -->
    <button id="collection-btn" onclick="openCollection()">
        <span style="font-size:20px;">ğŸ“‚</span> æ¡£æ¡ˆå®¤
    </button>
    
    <!-- æ”¶ä»¶ç®±æŒ‰é’® -->
    <button id="mailbox-btn" onclick="openMailbox()">
        <span style="font-size:20px;">ğŸ“©</span> é‚®ä»¶
        <div id="mail-notification" class="badge-notification"></div>
    </button>

    <button id="settings-btn" onclick="openSettings()">
        <span style="font-size:20px;">âš™ï¸</span> SETTINGS
    </button>
    <div id="category-bar"></div>
    <div class="content-wrapper">
        <div class="song-list-panel" id="song-list-container"></div>
        <div class="song-info-panel">
            <img id="preview-cover" class="cover-art" src="">
            <h1 id="preview-title" style="margin:5px;">-</h1>
            <p id="preview-artist" style="color:#0ff; margin:0;">-</p>
            <p id="preview-charter" style="color:#666; font-size:12px; margin-top:5px;">-</p>
            <button onclick="window.location.href='tutorial.html'" style="margin: 10px 0; background: transparent; border: 1px solid #0ff; color: #0ff; padding: 5px 20px; border-radius: 20px; cursor: pointer;">
                ğŸ“– è¿›å…¥æ–°æ‰‹æ•™å­¦ (TUTORIAL)
            </button>
            <div class="diff-selector">
                <button class="diff-btn" data-diff="easy">EASY</button>
                <button class="diff-btn" data-diff="normal">NORMAL</button>
                <button class="diff-btn" data-diff="hard">HARD</button>
                <button class="diff-btn" data-diff="expert">EXPERT</button>
            </div>
            <div id="best-record-box">
                <div class="record-label">BEST SCORE</div>
                <div class="record-val" id="record-score-val">0000000</div>
                <div class="record-badge badge-none" id="record-badge-el">CLEAR</div>
            </div>
            <button id="btn-start" class="main-btn">START GAME</button>
        </div>
    </div>
</div>

<div id="result-screen" class="overlay" style="display:none;">
    <div id="result-card">
        <div id="new-record-badge" class="new-record-badge">NEW RECORD!</div>

        <h2 style="color:#aaa; letter-spacing:5px; margin:0;">RESULT</h2>
        <div id="res-grade" class="grade-big">S</div>
        <div id="res-score" style="font-size:40px; font-family:monospace;">0000000</div>

        <!-- ç»“ç®—ç¢ç‰‡æ˜¾ç¤º -->
        <div style="margin-top:5px; margin-bottom:10px; font-family:monospace; color:#aa00ff; font-weight:bold; font-size:18px;">
            FRAGMENTS GET: +<span id="res-fragments-earned">0</span>
        </div>

        <div id="failed-msg" class="failed-text">CHALLENGE FAILED</div>
        <div class="stat-grid">
            <div class="stat-row" style="color:#ff00ff"><span class="stat-label">CRITICAL</span><span class="stat-val" id="res-crit">0</span></div>
            <div class="stat-row" style="color:#ffffff"><span class="stat-label">PERFECT</span><span class="stat-val" id="res-perf">0</span></div>
            <div class="stat-row" style="color:#ffcc00"><span class="stat-label">GOOD</span><span class="stat-val" id="res-good">0</span></div>
            <div class="stat-row" style="color:#a300cc"><span class="stat-label">BAD</span><span class="stat-val" id="res-bad">0</span></div>
            <div class="stat-row" style="color:#ff0055"><span class="stat-label">MISS</span><span class="stat-val" id="res-miss">0</span></div>
            <div style="height:1px; background:#444; margin:5px 0;"></div>
            <div class="stat-row"><span class="stat-label">MAX COMBO</span><span class="stat-val" id="res-maxcombo">0</span></div>
        </div>
        <div id="stamp-area" style="height:100px; display:flex; align-items:center; justify-content:center;"></div>
        <button class="main-btn" onclick="backToMenu()" style="margin-top:10px;">BACK</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- ç«‹ç»˜èµ„æºé…ç½® ---
    // è¯·åœ¨æ­¤å¤„ä¿®æ”¹ä½ çš„ç«‹ç»˜å›¾ç‰‡è·¯å¾„
    const CHAR_LIST = [
        { id: 'nana', name: 'Nana (Default)', src: 'nana/cover.png' }, // é»˜è®¤è§’è‰²
        { id: 'æ¸©æŸ”å±éšœ', name: 'æ¸©æŸ”å±éšœ', src: 'nana/1.png' }, // ç¤ºä¾‹ï¼šæœºå™¨äººè§’è‰²ï¼ˆéœ€æ›¿æ¢ä¸ºçœŸå®è·¯å¾„ï¼‰
        { id: 'æƒ…æ„Ÿæ´ªæµ', name: 'æƒ…æ„Ÿæ´ªæµ', src: 'nana/2.png' },   // ç¤ºä¾‹ï¼šå…¶ä»–è§’è‰²ï¼ˆéœ€æ›¿æ¢ä¸ºçœŸå®è·¯å¾„ï¼‰
        { id: 'ä½ çš„å‘¼å”¤', name: 'ä½ çš„å‘¼å”¤', src: 'nana/3.png' },
        { id: 'éŸ³éŸµå¾‹åŠ¨', name: 'éŸ³éŸµå¾‹åŠ¨', src: 'nana/5.png' }
    ];
    
    // å½“å¼€å¯â€œç©ºæ ¼è‡ªåŠ¨â€æ—¶ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°çš„ç‰¹æ®Šç«‹ç»˜ï¼ˆä¾‹å¦‚æœºç”²å½¢æ€æˆ–è¾…åŠ©æœºå™¨äººï¼‰
    // const AUTO_SPACE_CHAR_SRC = 'nana/3.png'; // (éœ€æ›¿æ¢ä¸ºçœŸå®è·¯å¾„)

    let audioCtx, bgmSource, previewSource;
    let soundPackConfig = [];       
    let loadedBuffers = {};         
    let synthBuffer = null;         
    let currentSong = null;
    let currentChartOffset = 0; 
    let songList = [], filteredList = [];
    let currentTag = 'ALL', selectedDiff = 'normal';
    
    let previewRequestId = 0;

    // è°ƒæ•´éŸ³é‡å¤§å°
    let bgmGainNode = null;
    let sfxGainNode = null;

    function ensureGains() {
    if (!audioCtx) return;
    if (!bgmGainNode) {
        bgmGainNode = audioCtx.createGain();
        bgmGainNode.connect(audioCtx.destination);
    }
    if (!sfxGainNode) {
        sfxGainNode = audioCtx.createGain();
        sfxGainNode.connect(audioCtx.destination);
    }
    bgmGainNode.gain.value = clamp01(userSettings.bgmVolume);
    sfxGainNode.gain.value = clamp01(userSettings.sfxVolume);
    }
    function clamp01(v){ v = Number(v); if (isNaN(v)) return 0.8; return Math.max(0, Math.min(1, v)); }

    const CLEAR_THRESHOLDS = {
        'easy': 600000,
        'normal': 600000,
        'hard': 700000,
        'expert': 800000
    };

    let userSettings = {
        speed: 2.0,
        inputMode: 'arrow', 
        offset: 0,
        devMode: false,
        autoMode: false,
        hitSound: true,       
        hitSoundPack: 'mp3',

        // NEW: éŸ³é‡è®¾ç½®ï¼ˆ0~1ï¼‰
        bgmVolume: 0.8,
        sfxVolume: 0.8,

        // æ–°å¢è®¾ç½®
        autoSpace: false, 
        selectedChar: 'nana',

        // NEW: æ–¹å‘é”®è‡ªåŠ¨æ¼”å¥
        autoArrows: { up:false, right:false, down:false, left:false }
    };

    let isPlaying = false, isPaused = false, isCountingDown = false;
    let notes = [], events = [], particles = [];
    let startTime = 0;
    let audioBuffer = null;
    let stats = { score:0, rawScore:0, maxCombo:0, combo:0, miss:0, bad:0, good:0, perfect:0, critical:0, auto:0 };
    let totalScoreUnit = 0; 
    let animationFrameId;
    let shakeIntensity = 0; 
    let bgFlash = 0;
    
    let hitBuffers = []; 

    const LANE_COLORS = ['#ff0055', '#00ffaa', '#00ccff', '#ffcc00', '#d600ff'];
    const KEYS_MAP_ARROW = { 'ArrowUp': 0, 'ArrowRight': 1, 'ArrowDown': 2, 'ArrowLeft': 3, 'Space': 4 };
    const KEYS_MAP_WASD  = { 'KeyW': 0, 'KeyD': 1, 'KeyS': 2, 'KeyA': 3, 'Space': 4 };
    const HIT_RADIUS = 260;
    
    const JUDGE_CRITICAL = 0.04;
    const JUDGE_PERFECT = 0.08;
    const JUDGE_GOOD = 0.2;
    const JUDGE_BAD = 0.32;
    const JUDGE_TRAP = 0.35; 

    // --- æ”¶è—ç³»ç»Ÿé€»è¾‘ ---
    let COLLECTION_DATA = { story: [], gallery: [] }; 

    async function initCollectionSystem() {
        try {
            const response = await fetch('collection.json?v=' + new Date().getTime());
            if (response.ok) {
                COLLECTION_DATA = await response.json();
                console.log("Collection data loaded successfully.");
            } else {
                console.warn("collection.json not found, using empty default.");
            }
        } catch (e) {
            console.error("Error loading collection.json:", e);
        }
    }

    let playerInventory = {
        fragments: 0,
        unlockedItems: ["s001","g001"] 
    };

    function loadInventory() {
        const saved = localStorage.getItem('neon_collection_v1');
        if (saved) {
            try {
                playerInventory = JSON.parse(saved);
                if(!playerInventory.unlockedItems) playerInventory.unlockedItems = ["s001"];
            } catch(e) { console.error("Inventory Load Error", e); }
        }
        updateFragmentDisplay();
    }

    function saveInventory() {
        localStorage.setItem('neon_collection_v1', JSON.stringify(playerInventory));
        updateFragmentDisplay();
    }

    function updateFragmentDisplay() {
        document.getElementById('fragment-count-display').innerText = playerInventory.fragments;
        document.getElementById('col-panel-fragments').innerText = playerInventory.fragments;
    }

    let currentCollectionTab = 'story';
    let selectedCollectionItem = null;

    window.openCollection = function() {
        document.getElementById('collection-overlay').style.display = 'flex';
        switchCollectionTab('story');
    };

    window.closeCollection = function() {
        document.getElementById('collection-overlay').style.display = 'none';
    };

    window.switchCollectionTab = function(tab) {
        currentCollectionTab = tab;
        document.querySelectorAll('.col-tab').forEach(b => b.classList.remove('active'));
        document.querySelector(`.col-tab[onclick="switchCollectionTab('${tab}')"]`).classList.add('active');
        
        renderCollectionList();
        document.getElementById('collection-detail-container').innerHTML = '<div class="detail-placeholder">SELECT A FILE TO DECRYPT</div>';
        selectedCollectionItem = null;
    };

    function renderCollectionList() {
        const container = document.getElementById('collection-list-container');
        container.innerHTML = '';
        const list = COLLECTION_DATA[currentCollectionTab];

        list.forEach(item => {
            const isUnlocked = playerInventory.unlockedItems.includes(item.id);
            const div = document.createElement('div');
            div.className = `col-item-card ${isUnlocked ? '' : 'locked'}`;
            div.innerHTML = `
                <div class="col-item-info">
                    <h4>${item.title}</h4>
                    <p>${isUnlocked ? 'DECRYPTED' : 'ENCRYPTED'}</p>
                </div>
                ${!isUnlocked ? '<span class="lock-icon">ğŸ”’</span>' : ''}
            `;
            div.onclick = () => selectCollectionItem(item, div, isUnlocked);
            container.appendChild(div);
        });
    }

    async function selectCollectionItem(item, el, isUnlocked) {
        document.querySelectorAll('.col-item-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        selectedCollectionItem = item;

        const container = document.getElementById('collection-detail-container');
        
        if (isUnlocked) {
            // å·²è§£é”è§†å›¾
            if (item.type === 'story') {
                // ã€NEWã€‘æ”¯æŒ .txt æ–‡ä»¶è¯»å–
                let contentHTML = '';
                if (item.src && item.src.endsWith('.txt')) {
                    container.innerHTML = `<div class="loading-spinner" style="width:30px;height:30px;"></div><p style="color:#888;">DECODING TEXT STREAM...</p>`;
                    try {
                        const res = await fetch(item.src);
                        if(res.ok) {
                            const text = await res.text();
                            contentHTML = `<div class="detail-text">${text}</div>`;
                        } else {
                            contentHTML = `<div class="detail-text" style="color:#f05;">ERROR: Data Corrupted (404)</div>`;
                        }
                    } catch(e) {
                        contentHTML = `<div class="detail-text" style="color:#f05;">ERROR: Data Corrupted (${e})</div>`;
                    }
                } else {
                    // å…¼å®¹æ—§çš„ç›´æ¥å†…åµŒ content æ¨¡å¼
                    contentHTML = `<div class="detail-text">${item.content || 'No Data'}</div>`;
                }

                container.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-title">${item.title}</div>
                        ${contentHTML}
                    </div>
                `;
            } else {
                // ã€NEWã€‘å›¾ç‰‡æ”¯æŒç‚¹å‡»æ”¾å¤§
                container.innerHTML = `
                    <div class="detail-view" style="align-items:center;">
                        <div class="detail-title">${item.title}</div>
                        <img class="detail-image" src="${item.src}" alt="Art" onclick="openImageViewer('${item.src}')" title="Click to Expand">
                        <div style="font-size:12px; color:#666;">CLICK IMAGE TO EXPAND</div>
                    </div>
                `;
            }
        } else {
            // æœªè§£é”è§†å›¾
            const canUnlock = playerInventory.fragments >= item.cost;
            container.innerHTML = `
                <div class="detail-view" style="justify-content:center; align-items:center; text-align:center;">
                    <div style="font-size:60px; margin-bottom:20px;">ğŸ”’</div>
                    <div class="detail-title">FILE ENCRYPTED</div>
                    <p style="color:#888;">Spend Fragments to decrypt this file.</p>
                    <div class="unlock-area">
                        <span class="frag-cost">COST: ${item.cost} FRAGMENTS</span>
                        <button class="unlock-btn" onclick="unlockCurrentItem()" ${canUnlock ? '' : 'disabled'}>
                            ${canUnlock ? 'DECRYPT NOW' : 'INSUFFICIENT DATA'}
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // --- å›¾ç‰‡æŸ¥çœ‹å™¨é€»è¾‘ (New) ---
    // çŠ¶æ€å˜é‡ï¼šç¼©æ”¾æ¯”ä¾‹ã€ä½ç§»Xã€ä½ç§»Yã€æ˜¯å¦æ‹–æ‹½ä¸­ã€ä¸Šä¸€æ¬¡é¼ æ ‡ä½ç½®
    let viewerState = {
        scale: 1,
        pX: 0,
        pY: 0,
        isDragging: false,
        lastX: 0,
        lastY: 0
    };

    function openImageViewer(src) {
        const overlay = document.getElementById('image-viewer-overlay');
        const img = document.getElementById('viewer-img');
        
        // é‡ç½®çŠ¶æ€
        viewerState = { scale: 1, pX: 0, pY: 0, isDragging: false, lastX: 0, lastY: 0 };
        img.src = src;
        updateViewerTransform();
        
        overlay.style.display = 'flex';
        
        // ç»‘å®šäº‹ä»¶ (æ³¨æ„ï¼šä¸ºäº†é˜²æ­¢é‡å¤ç»‘å®šï¼Œè¿™é‡Œä½¿ç”¨äº†è¦†ç›– on... å±æ€§çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç”¨ add/removeEventListener)
        
        // 1. æ»šè½®ç¼©æ”¾
        overlay.onwheel = function(e) {
            e.preventDefault();
            // æ»šè½®å‘ä¸‹(æ­£)ç¼©å°ï¼Œå‘ä¸Š(è´Ÿ)æ”¾å¤§
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            let newScale = viewerState.scale + delta;
            
            // é™åˆ¶ç¼©æ”¾èŒƒå›´ (0.2å€ åˆ° 5å€)
            if (newScale < 0.2) newScale = 0.2;
            if (newScale > 5.0) newScale = 5.0;
            
            viewerState.scale = newScale;
            updateViewerTransform();
        };

        // 2. é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
        img.onmousedown = function(e) {
            e.preventDefault(); // é˜²æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½å›¾ç‰‡è¡Œä¸º
            viewerState.isDragging = true;
            viewerState.lastX = e.clientX;
            viewerState.lastY = e.clientY;
            img.style.cursor = 'grabbing';
        };

        // 3. é¼ æ ‡ç§»åŠ¨ (ç»‘å®šåœ¨ document ä¸Šï¼Œé˜²æ­¢é¼ æ ‡ç§»å‡ºå›¾ç‰‡èŒƒå›´å¯¼è‡´æ–­è§¦)
        document.onmousemove = function(e) {
            if (!viewerState.isDragging) return;
            e.preventDefault();

            const deltaX = e.clientX - viewerState.lastX;
            const deltaY = e.clientY - viewerState.lastY;

            // è€ƒè™‘ç¼©æ”¾æ¯”ä¾‹å¯¹ç§»åŠ¨é€Ÿåº¦çš„å½±å“ï¼ˆå¯é€‰ï¼Œè¿™é‡Œç›´æ¥1:1ç§»åŠ¨æ›´ç›´è§‚ï¼‰
            viewerState.pX += deltaX;
            viewerState.pY += deltaY;

            viewerState.lastX = e.clientX;
            viewerState.lastY = e.clientY;

            updateViewerTransform();
        };

        // 4. é¼ æ ‡æ¾å¼€
        document.onmouseup = function() {
            viewerState.isDragging = false;
            img.style.cursor = 'grab';
        };
    }

    function updateViewerTransform() {
        const img = document.getElementById('viewer-img');
        // ä½¿ç”¨ translate å’Œ scale ç»„åˆå˜æ¢
        img.style.transform = `translate(${viewerState.pX}px, ${viewerState.pY}px) scale(${viewerState.scale})`;
    }

    function closeImageViewer() {
        const overlay = document.getElementById('image-viewer-overlay');
        overlay.style.display = 'none';
        
        // æ¸…ç†äº‹ä»¶é˜²æ­¢å†…å­˜æ³„æ¼æˆ–å¹²æ‰°å…¶ä»–åŠŸèƒ½
        overlay.onwheel = null;
        const img = document.getElementById('viewer-img');
        img.onmousedown = null;
        document.onmousemove = null;
        document.onmouseup = null;
    }

    function downloadCurrentImage() {
        const src = document.getElementById('viewer-img').src;
        if(!src) return;
        const a = document.createElement('a');
        a.href = src;
        a.download = 'neon_pulse_archive.png'; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.unlockCurrentItem = function() {
        if (!selectedCollectionItem) return;
        if (playerInventory.fragments >= selectedCollectionItem.cost) {
            playerInventory.fragments -= selectedCollectionItem.cost;
            playerInventory.unlockedItems.push(selectedCollectionItem.id);
            saveInventory();
            renderCollectionList();
            switchCollectionTab(currentCollectionTab); // åˆ·æ–°è¯¦æƒ…
        }
    };

    // --- æ”¶ä»¶ç®±é€»è¾‘ç³»ç»Ÿ ---
    let mailData = [];
    const DEFAULT_MAILS = [
        {
            id: "system_welcome",
            title: "Welcome to Neon Pulse",
            sender: "System",
            date: "2025-01-01",
            content: "Welcome, Runner!\n\nThis is your private inbox. Check here for updates, rewards, and messages from the developers.\n\nEnjoy the rhythm!"
        }
    ];

    async function initMailSystem() {
        try {
            const response = await fetch('mails.json');
            if (response.ok) {
                mailData = await response.json();
            } else {
                mailData = DEFAULT_MAILS;
            }
        } catch (e) {
            console.log("Could not load mails.json, using default.", e);
            mailData = DEFAULT_MAILS;
        }
        checkUnreadMails();
    }

    function checkUnreadMails() {
        const readList = JSON.parse(localStorage.getItem('neon_read_mails') || '[]');
        let unreadCount = 0;
        mailData.forEach(mail => {
            if (!readList.includes(mail.id)) unreadCount++;
        });
        
        const badge = document.getElementById('mail-notification');
        if (unreadCount > 0) {
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }

    window.openMailbox = function() {
        document.getElementById('mailbox-overlay').style.display = 'flex';
        renderMailList();
    };

    window.closeMailbox = function() {
        document.getElementById('mailbox-overlay').style.display = 'none';
        checkUnreadMails(); 
    };

    function renderMailList() {
        const container = document.getElementById('mail-list-container');
        container.innerHTML = '';
        const readList = JSON.parse(localStorage.getItem('neon_read_mails') || '[]');

        mailData.forEach((mail, index) => {
            const isRead = readList.includes(mail.id);
            const div = document.createElement('div');
            div.className = 'mail-item' + (isRead ? '' : ' unread');
            div.innerHTML = `
                <div class="mail-item-title">${mail.title}</div>
                <div class="mail-item-sender">${mail.sender}</div>
            `;
            div.onclick = () => selectMail(index, div);
            container.appendChild(div);
        });

        document.getElementById('mail-empty-state').style.display = 'flex';
        document.getElementById('mail-detail-view').style.display = 'none';
    }

    function selectMail(index, el) {
        document.querySelectorAll('.mail-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        el.classList.remove('unread'); 

        const mail = mailData[index];
        document.getElementById('mail-empty-state').style.display = 'none';
        const detailView = document.getElementById('mail-detail-view');
        detailView.style.display = 'flex';
        
        document.getElementById('mail-view-title').innerText = mail.title;
        document.getElementById('mail-view-sender').innerText = "From: " + mail.sender;
        document.getElementById('mail-view-date').innerText = mail.date || "";
        document.getElementById('mail-view-content').innerHTML = mail.content;

        const readList = JSON.parse(localStorage.getItem('neon_read_mails') || '[]');
        if (!readList.includes(mail.id)) {
            readList.push(mail.id);
            localStorage.setItem('neon_read_mails', JSON.stringify(readList));
        }
    }

    // --- æˆç»©å­˜å‚¨é€»è¾‘ ---
    const CLEAR_TYPE = {
        NONE: 0,
        FAILED: 1, 
        CLEAR: 2,  
        FC: 3,     
        AP: 4,     
        AC: 5      
    };

    function getStorageKey() {
        return 'neon_pulse_records_v1';
    }

    function loadRecords() {
        const data = localStorage.getItem(getStorageKey());
        return data ? JSON.parse(data) : {};
    }

    function saveRecord(songId, diff, score, clearType) {
        if (userSettings.autoMode || userSettings.devMode || isAssistAutoActive()) {
            console.log("Auto/Dev/Assist mode active. Score not saved.");
            return;
        }

        const records = loadRecords();
        const key = `${songId}_${diff}`;
        const existing = records[key] || { score: 0, clearType: 0 };

        let shouldSave = false;
        if (score > existing.score) {
            existing.score = score;
            shouldSave = true;
        }
        if (clearType > existing.clearType) {
            existing.clearType = clearType;
            shouldSave = true;
        }

        if (shouldSave) {
            records[key] = existing;
            localStorage.setItem(getStorageKey(), JSON.stringify(records));
        }
    }

    function updateRecordDisplay() {
        if (!currentSong) return;
        const records = loadRecords();
        const key = `${currentSong.id}_${selectedDiff}`;
        const rec = records[key];

        const scoreEl = document.getElementById('record-score-val');
        const badgeEl = document.getElementById('record-badge-el');

        if (rec) {
            scoreEl.innerText = rec.score.toString().padStart(7, '0');
            badgeEl.className = 'record-badge';
            badgeEl.style.display = 'block';

            switch (rec.clearType) {
                case CLEAR_TYPE.AC: badgeEl.innerText = "ALL CRITICAL"; badgeEl.classList.add('badge-ac'); break;
                case CLEAR_TYPE.AP: badgeEl.innerText = "ALL PERFECT"; badgeEl.classList.add('badge-ap'); break;
                case CLEAR_TYPE.FC: badgeEl.innerText = "FULL COMBO"; badgeEl.classList.add('badge-fc'); break;
                case CLEAR_TYPE.CLEAR: badgeEl.innerText = "CLEAR"; badgeEl.classList.add('badge-clear'); break;
                default: badgeEl.style.display = 'none';
            }
        } else {
            scoreEl.innerText = "0000000";
            badgeEl.style.display = 'none';
        }
    }

    // --- (åˆå§‹åŒ–åŠå…¶ä»–é€»è¾‘) ---
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function enterGame() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } else if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        loadHitSounds();
        initSynthSound();

        const splash = document.getElementById('splash-screen');
        splash.style.opacity = '0';
        splash.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
            splash.style.display = 'none';
            document.getElementById('song-select-screen').style.display = 'flex';
            init(); 
        }, 500);
    }

    async function initSoundSystem() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        try {
            const res = await fetch('soundpacks.json');
            soundPackConfig = await res.json();
        } catch (e) {
            soundPackConfig = [{id: 'synth', name: 'Synth (Fallback)', type: 'synth'}];
        }
        const select = document.getElementById('soundpack-select');
        select.innerHTML = ''; 
        soundPackConfig.forEach(pack => {
            const opt = document.createElement('option');
            opt.value = pack.id;
            opt.innerText = pack.name;
            select.appendChild(opt);
        });
        if (userSettings.hitSoundPack) {
            const exists = soundPackConfig.find(p => p.id === userSettings.hitSoundPack);
            select.value = exists ? userSettings.hitSoundPack : soundPackConfig[0].id;
        } else {
            select.value = soundPackConfig[0].id;
        }
        select.addEventListener('change', async (e) => {
            const packId = e.target.value;
            userSettings.hitSoundPack = packId;
            saveSettings();
            await loadSoundPack(packId); 
        });
        initSynthSound(); 
        await loadSoundPack(select.value); 
    }

    async function loadSoundPack(packId) {
        if (!audioCtx) return;
        if (loadedBuffers[packId] && loadedBuffers[packId].length > 0) return; 
        const pack = soundPackConfig.find(p => p.id === packId);
        if (!pack || pack.type === 'synth') return;
        
        const promises = pack.files.map(async (url) => {
            try {
                const res = await fetch(url);
                const buf = await res.arrayBuffer();
                return await audioCtx.decodeAudioData(buf);
            } catch (e) { return null; }
        });
        const buffers = await Promise.all(promises);
        loadedBuffers[packId] = buffers.filter(b => b !== null);
    }

    function initSynthSound() {
        if (synthBuffer || !audioCtx) return;
        const duration = 0.12; 
        const sampleRate = audioCtx.sampleRate;
        const length = sampleRate * duration; 
        const buffer = audioCtx.createBuffer(1, length, sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < length; i++) {
            const t = i / length;
            const time = i / sampleRate;
            const freq = 523 + 50 * Math.exp(-50 * time);
            const wave = Math.sin(2 * Math.PI * freq * time) + Math.asin(Math.sin(2 * Math.PI * freq * time)) * 0.5;
            data[i] = wave * Math.pow(1 - t, 2.5) * 0.5;
        }
        synthBuffer = buffer;
    }

    async function init() {
        loadSettings();
        await initSoundSystem();
        initMailSystem();
        loadInventory();

        await initCollectionSystem();

        try {
            const res = await fetch('songs.json');
            songList = await res.json();
        } catch(e) {
            songList = [{ id:'demo', title:'Demo Song', artist:'System', charter:'AI', tags:['Demo'], cover:'', charts:{'normal':null}, audio:null }];
        }
        
        initCategoryBar();
        filterSongs('ALL'); 

        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.onclick = () => {
                if(btn.classList.contains('disabled')) return;
                selectedDiff = btn.dataset.diff;
                updateDiffUI();
                updateRecordDisplay(); 
            };
        });
        
        const speedInput = document.getElementById('speed-input');
        speedInput.value = userSettings.speed;
        document.getElementById('speed-val').innerText = parseFloat(userSettings.speed).toFixed(1);
        speedInput.addEventListener('input', e => {
            userSettings.speed = parseFloat(e.target.value);
            document.getElementById('speed-val').innerText = userSettings.speed.toFixed(1);
            saveSettings();
        });

        const modeSelect = document.getElementById('input-mode-select');
        modeSelect.value = userSettings.inputMode;
        modeSelect.addEventListener('change', e => { userSettings.inputMode = e.target.value; saveSettings(); });

        const offsetInput = document.getElementById('offset-input');
        offsetInput.value = userSettings.offset;
        offsetInput.addEventListener('change', e => { userSettings.offset = parseInt(e.target.value) || 0; saveSettings(); });

        const devCheck = document.getElementById('dev-mode-check');
        devCheck.checked = userSettings.devMode || false;
        devCheck.addEventListener('change', e => { userSettings.devMode = e.target.checked; saveSettings(); });

        const autoCheck = document.getElementById('auto-mode-check');
        autoCheck.checked = userSettings.autoMode || false;
        autoCheck.addEventListener('change', e => { userSettings.autoMode = e.target.checked; saveSettings(); });

        const soundCheck = document.getElementById('hitsound-check');
        soundCheck.checked = userSettings.hitSound !== false; 
        soundCheck.addEventListener('change', e => { userSettings.hitSound = e.target.checked; saveSettings(); });

        // --- æ–°å¢è®¾ç½®é¡¹åˆå§‹åŒ– ---
        const autoSpaceCheck = document.getElementById('auto-space-check');
        autoSpaceCheck.checked = userSettings.autoSpace || false;
        autoSpaceCheck.addEventListener('change', e => { userSettings.autoSpace = e.target.checked; saveSettings(); });

        const charSelect = document.getElementById('character-select');
        charSelect.innerHTML = '';
        CHAR_LIST.forEach(char => {
            const opt = document.createElement('option');
            opt.value = char.id;
            opt.innerText = char.name;
            charSelect.appendChild(opt);
        });
        charSelect.value = userSettings.selectedChar || CHAR_LIST[0].id;
        charSelect.addEventListener('change', e => { 
            userSettings.selectedChar = e.target.value; 
            saveSettings(); 
        });

        document.getElementById('btn-start').onclick = startGame;
        checkUpdatePopup();

        // --- éŸ³é‡è®¾ç½®åˆå§‹åŒ– ---
        const bgmVol = document.getElementById('bgm-vol-input');
        const sfxVol = document.getElementById('sfx-vol-input');
        bgmVol.value = clamp01(userSettings.bgmVolume);
        sfxVol.value = clamp01(userSettings.sfxVolume);
        document.getElementById('bgm-vol-val').innerText = Number(bgmVol.value).toFixed(2);
        document.getElementById('sfx-vol-val').innerText = Number(sfxVol.value).toFixed(2);

        bgmVol.addEventListener('input', e => {
        userSettings.bgmVolume = clamp01(e.target.value);
        document.getElementById('bgm-vol-val').innerText = userSettings.bgmVolume.toFixed(2);
        saveSettings();
        if (audioCtx) { ensureGains(); }
        });
        sfxVol.addEventListener('input', e => {
        userSettings.sfxVolume = clamp01(e.target.value);
        document.getElementById('sfx-vol-val').innerText = userSettings.sfxVolume.toFixed(2);
        saveSettings();
        if (audioCtx) { ensureGains(); }
        });

        // æ–¹å‘è‡ªåŠ¨æ¼”å¥
        const upChk = document.getElementById('auto-up-check');
        const rightChk = document.getElementById('auto-right-check');
        const downChk = document.getElementById('auto-down-check');
        const leftChk = document.getElementById('auto-left-check');

        upChk.checked = !!userSettings.autoArrows?.up;
        rightChk.checked = !!userSettings.autoArrows?.right;
        downChk.checked = !!userSettings.autoArrows?.down;
        leftChk.checked = !!userSettings.autoArrows?.left;

        function saveArrowAuto() {
        if (!userSettings.autoArrows) userSettings.autoArrows = { up:false, right:false, down:false, left:false };
        userSettings.autoArrows.up = upChk.checked;
        userSettings.autoArrows.right = rightChk.checked;
        userSettings.autoArrows.down = downChk.checked;
        userSettings.autoArrows.left = leftChk.checked;
        saveSettings();
        }
        upChk.addEventListener('change', saveArrowAuto);
        rightChk.addEventListener('change', saveArrowAuto);
        downChk.addEventListener('change', saveArrowAuto);
        leftChk.addEventListener('change', saveArrowAuto);

        initSettingsTabs();
    }

    // åˆ¤æ–­æ˜¯å¦è¾…åŠ©æ¼”å¥
    function isAssistAutoActive() {
        const a = userSettings.autoArrows || {};
        const arrowAutoOn = !!(a.up || a.right || a.down || a.left);
        return !!(userSettings.autoSpace || arrowAutoOn);
    }

    function saveSettings() {
        localStorage.setItem('neon_settings_v4', JSON.stringify(userSettings));
    }

    function loadSettings() {
        const saved = localStorage.getItem('neon_settings_v4'); 
        if(saved) {
            try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } catch(e) {}
        }
    }

    window.openSettings = function() { document.getElementById('settings-overlay').style.display = 'flex'; };
    window.closeSettings = function() {
        document.getElementById('settings-overlay').style.display = 'none';
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    };

    async function loadHitSounds() {
        if (!audioCtx) return;
        hitBuffers = []; 
    }

    function initSettingsTabs() {
        const tabs = Array.from(document.querySelectorAll('.settings-tab'));
        const sections = Array.from(document.querySelectorAll('.settings-section'));

        function activate(tabName) {
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            sections.forEach(s => s.classList.toggle('active', s.dataset.section === tabName));
        }

        tabs.forEach(t => {
            t.addEventListener('click', () => activate(t.dataset.tab));
        });

        // é»˜è®¤é¡µ
        activate('gameplay');
    }

    function playHitSound(lane) {
        if (!userSettings.hitSound || !audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const currentPackId = userSettings.hitSoundPack;
        const packConfig = soundPackConfig.find(p => p.id === currentPackId);
        
        if (packConfig && packConfig.type === 'synth') {
            if (!synthBuffer) return;
            const source = audioCtx.createBufferSource();
            source.buffer = synthBuffer;
            source.detune.value = [400, 700, 200, 0, 1200][lane] || 0; 
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = lane === 4 ? 0.8 : 0.6;
            source.connect(gainNode);
            ensureGains();
            gainNode.connect(sfxGainNode);
            source.start(0);
            return;
        }

        const buffers = loadedBuffers[currentPackId];
        if (buffers && buffers[lane]) {
            const source = audioCtx.createBufferSource();
            source.buffer = buffers[lane];
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = (lane === 4) ? 1.0 : 0.8; 
            source.connect(gainNode);
            ensureGains();
            gainNode.connect(sfxGainNode);
            source.start(0);
        }
    }

    function initCategoryBar() {
        const bar = document.getElementById('category-bar');
        const tags = new Set(['ALL']);
        songList.forEach(s => (s.tags || []).forEach(t => tags.add(t)));
        bar.innerHTML = '';
        tags.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn' + (tag==='ALL'?' active':'');
            btn.innerText = tag;
            btn.onclick = () => {
                document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterSongs(tag);
            };
            bar.appendChild(btn);
        });
    }

    function filterSongs(tag) {
        currentTag = tag;
        filteredList = tag === 'ALL' ? songList : songList.filter(s => (s.tags || []).includes(tag));
        renderSongList();
    }

    function renderSongList() {
        const c = document.getElementById('song-list-container');
        c.innerHTML = '';
        if(!filteredList.length) { c.innerHTML='<div style="padding:20px;color:#666">No songs</div>'; return; }
        filteredList.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'song-item';
            d.innerHTML = `<div style="font-weight:bold;">${s.title}</div><div style="font-size:12px; color:#aaa;">${s.artist}</div>`;
            d.onclick = () => selectSong(i);
            c.appendChild(d);
        });
        selectSong(0);
    }

    function selectSong(idx) {
        document.querySelectorAll('.song-item').forEach(e=>e.classList.remove('selected'));
        if(filteredList[idx]) document.querySelectorAll('.song-item')[idx].classList.add('selected');
        currentSong = filteredList[idx];
        if(!currentSong) return;

        previewRequestId++;

        document.getElementById('preview-title').innerText = currentSong.title;
        document.getElementById('preview-artist').innerText = currentSong.artist;
        document.getElementById('preview-charter').innerText = "Charter: " + (currentSong.charter||"?");
        document.getElementById('preview-cover').src = currentSong.cover||'';
        document.getElementById('bg-layer').style.backgroundImage = `url('${currentSong.cover}')`;

        const charts = currentSong.charts||{};
        document.querySelectorAll('.diff-btn').forEach(btn => {
            const d = btn.dataset.diff;
            const hasChart = charts[d] || (currentSong.id === 'demo' && d==='normal');
            if (!hasChart) btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        });

        if (!charts[selectedDiff] && currentSong.id!=='demo') {
             const available = Object.keys(charts).find(k => charts[k]);
             if (available) selectedDiff = available;
        }

        updateDiffUI();
        updateRecordDisplay(); 
        playPreview(currentSong, previewRequestId);
    }

    function updateDiffUI() {
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.diff === selectedDiff) {
                btn.classList.add('active');
            }
        });
    }

    async function playPreview(song, reqId) {
        stopPreview();
        if(!song.audio) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') try{await audioCtx.resume();}catch(e){}
        try {
            const buf = await fetch(song.audio).then(r=>r.arrayBuffer()).then(d=>audioCtx.decodeAudioData(d));
            if (reqId !== previewRequestId) return;
            previewSource = audioCtx.createBufferSource();
            previewSource.buffer = buf;
            previewSource.connect(audioCtx.destination);
            const start = song.preview_start || 10;
            previewSource.loop = true; previewSource.loopStart = start; previewSource.loopEnd = start+30;
            previewSource.start(0, start);
        } catch(e){}
    }
    function stopPreview() { if(previewSource) { try{previewSource.stop();}catch(e){}; previewSource=null; } }

    async function startGame() {
        previewRequestId++; 
        stopPreview();      

        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';
        document.getElementById('loading-text').innerText = "Loading Assets & Decoding...";
        document.getElementById('song-select-screen').style.display = 'none';
        
        try {
            const tasks = [];
            if (currentSong.id === 'demo') {
                tasks.push(new Promise(async (resolve) => {
                     await new Promise(r => setTimeout(r, 1000));
                     const sr = audioCtx.sampleRate;
                     audioBuffer = audioCtx.createBuffer(1, sr * 30, sr);
                     const data = audioBuffer.getChannelData(0);
                     for(let i=0; i<data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.1;
                     notes = []; events = [{time:5, type:'shake'}, {time:10, type:'shake'}];
                     for(let i=0; i<30; i++) notes.push({time:2+i*0.8, lane:i%5, duration:i%4===0?1:0});
                     resolve();
                }));
            } else {
                const chartUrl = currentSong.charts[selectedDiff];
                const audioTask = fetch(currentSong.audio)
                    .then(r => r.arrayBuffer())
                    .then(buffer => audioCtx.decodeAudioData(buffer))
                    .then(decoded => { audioBuffer = decoded; });
                const chartTask = fetch(chartUrl)
                    .then(r => r.json())
                    .then(data => {
                        notes = data.notes || [];
                        events = data.events || [];
                        currentChartOffset = data.offset || 0;
                    });
                tasks.push(audioTask);
                tasks.push(chartTask);
            }

            const currentPackId = userSettings.hitSoundPack;
            if (currentPackId && currentPackId !== 'synth') {
                if (!loadedBuffers[currentPackId] || loadedBuffers[currentPackId].length === 0) {
                     document.getElementById('loading-text').innerText = "Downloading Sound Effects...";
                     tasks.push(loadSoundPack(currentPackId));
                }
            }
            await Promise.all(tasks);

        } catch(e) { 
            console.error(e);
            alert("Error loading game data. Please check your connection."); 
            loadingOverlay.style.display = 'none'; 
            backToMenu(); 
            return; 
        }

        loadingOverlay.style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('bg-layer').style.opacity = 0.5;

        stopPreview(); 

        const clearScore = CLEAR_THRESHOLDS[selectedDiff] || 600000;
        const markerPct = (clearScore / 1000000) * 100;
        document.getElementById('score-bar-marker').style.bottom = markerPct + "%";
        document.getElementById('score-bar-marker').classList.remove('marker-passed');
        const barFill = document.getElementById('score-bar-fill');
        barFill.style.height = "0%";
        barFill.className = ''; 

        const autoIndicator = document.getElementById('auto-indicator');
        autoIndicator.style.display = userSettings.autoMode ? 'block' : 'none';

        if(userSettings.devMode) document.getElementById('hud-detail').innerHTML += " DEV";

        checkSimultaneousNotes();
        notes.forEach(n => { n.hit=false; n.processed=false; n.headHit=false; n.tailHit=false; n.holding=false; });
        events.forEach(e => e.triggered=false);
        
        let maxCombo = 0;
        notes.forEach(n => maxCombo += (n.duration>0 ? 2 : 1));
        totalScoreUnit = 1000000 / (maxCombo||1);

        stats = { score:0, rawScore:0, maxCombo:0, combo:0, miss:0, bad:0, good:0, perfect:0, critical:0, auto:0 };
        particles = [];
        shakeIntensity = 0; bgFlash = 0;

        document.getElementById('hud-title').innerText = currentSong.title;
        document.getElementById('hud-detail').innerText = `${currentSong.artist} - ${selectedDiff.toUpperCase()}`;
        document.getElementById('score-display').innerText = "0000000";
        document.getElementById('combo-display').style.opacity = 0;

        // --- è®¾ç½®ç«‹ç»˜å›¾ç‰‡ ---
        const charImg = document.getElementById('ingame-char-img');
        const selected = CHAR_LIST.find(c => c.id === userSettings.selectedChar) || CHAR_LIST[0];
        charImg.src = selected.src;
        charImg.style.filter = ""; // é‡ç½®æ»¤é•œ
        

        ensureGains();
        bgmSource = audioCtx.createBufferSource();
        bgmSource.buffer = audioBuffer;
        bgmSource.connect(bgmGainNode);
        bgmSource.start(0);
        startTime = audioCtx.currentTime;
        isPlaying = true; isPaused = false; isCountingDown = false;

        cancelAnimationFrame(animationFrameId);
        gameLoop();
    }

    function checkSimultaneousNotes() {
        notes.sort((a,b) => a.time - b.time);
        for(let i=0; i<notes.length; i++) notes[i].isSync = false;
        for(let i=0; i<notes.length; i++) {
            let n1 = notes[i];
            for(let j=i+1; j<notes.length; j++) {
                let n2 = notes[j];
                if(Math.abs(n2.time - n1.time) < 0.05) {
                    n1.isSync = true; n2.isSync = true;
                } else break;
            }
        }
    }

    function gameLoop() {
        if (!isPlaying || isPaused || isCountingDown) return;
        animationFrameId = requestAnimationFrame(gameLoop);
        const rawTime = audioCtx.currentTime - startTime;
        const now = rawTime - (userSettings.offset / 1000);
        if (rawTime > audioBuffer.duration + 1.5) { finishGame(); return; }
        
        events.forEach(e => { if(!e.triggered && now >= e.time) { e.triggered = true; if(e.type === 'shake') { shakeIntensity = 30; bgFlash = 1.0; } } });
        shakeIntensity *= 0.9; bgFlash *= 0.9; if(bgFlash < 0.01) bgFlash = 0;
        document.getElementById('bg-layer').style.filter = `blur(8px) brightness(${0.5 + bgFlash})`;
        document.getElementById('progress-bar').style.width = ((rawTime/audioBuffer.duration)*100) + "%";

        // --- åˆ¤å®šé€»è¾‘ ---
        notes.forEach(n => {
            // å…¨å±€è‡ªåŠ¨(AutoMode) æˆ– å¼€å‘è€…æ¨¡å¼
            const isGlobalAuto = (userSettings.devMode || userSettings.autoMode);
            const a = userSettings.autoArrows || {};
            const isArrowAutoLane =
            (n.lane === 0 && a.up) ||
            (n.lane === 1 && a.right) ||
            (n.lane === 2 && a.down) ||
            (n.lane === 3 && a.left);

            const isSpaceAuto = (userSettings.autoSpace && n.lane === 4);
            const isAssistAuto = isSpaceAuto || isArrowAutoLane;

            // è‡ªåŠ¨ç‚¹å‡»åˆ¤å®šæ¡ä»¶
            if (!n.processed && !n.headHit && now >= n.time && (isGlobalAuto || isAssistAuto)) {
                n.headHit = true;
                createExplosion(n.lane);

                let hitType = 'perfect';
                if (userSettings.autoMode || isAssistAuto) hitType='auto'; // ç©ºæ ¼/æ–¹å‘é”®è‡ªåŠ¨ = AUTO

                if (n.duration === 0) {
                    n.processed = true;
                    handleHit(hitType, n.lane);
                } else {
                    n.holding = true;
                    handleHit(hitType, n.lane);
                }
            }

            // è‡ªåŠ¨é•¿æŒ‰ç»“æŸåˆ¤å®š
            if (n.holding && (isGlobalAuto || isAssistAuto) && now >= n.time + n.duration) {
            n.holding = false;
            n.processed = true;
            createExplosion(n.lane);

            let hitType = 'perfect';
            if (userSettings.autoMode || isAssistAuto) hitType='auto';

            handleHit(hitType, n.lane);
            }

        });

        notes.forEach(n => {
            if(n.processed) return;
            
            // å¦‚æœè¯¥éŸ³ç¬¦æ˜¯ç©ºæ ¼ä¸”å¼€å¯äº†è‡ªåŠ¨ï¼Œä¸è¦è®©å®ƒåˆ¤å®šä¸ºMISS
            const a2 = userSettings.autoArrows || {};
            const isAssist =
            (userSettings.autoSpace && n.lane === 4) ||
            (n.lane === 0 && a2.up) ||
            (n.lane === 1 && a2.right) ||
            (n.lane === 2 && a2.down) ||
            (n.lane === 3 && a2.left);
            
            if(!userSettings.devMode && !userSettings.autoMode && !isAssist) {
                if(!n.headHit && now > n.time + JUDGE_BAD) { n.processed = true; handleHit('miss', n.lane); }
                if(n.holding && now > n.time + n.duration + JUDGE_BAD) { n.holding = false; n.processed = true; handleHit('miss', n.lane); }
            }
        });

        ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height);
        if (shakeIntensity > 0) {
            const dx = (Math.random() - 0.5) * shakeIntensity;
            const dy = (Math.random() - 0.5) * shakeIntensity;
            ctx.translate(canvas.width/2 + dx, canvas.height/2 + dy);
            ctx.translate(-canvas.width/2, -canvas.height/2);
        }
        const cx = canvas.width/2, cy = canvas.height/2;
        const travel = 3.0 / userSettings.speed;
        drawGameContent(cx, cy, now, travel, false);
        ctx.restore(); 
        document.getElementById('score-display').innerText = stats.score.toString().padStart(7,'0');
    }
    
    function drawGameContent(cx, cy, now, travel, isGhost) {
        ctx.beginPath(); ctx.arc(cx,cy,HIT_RADIUS,0,6.28); 
        ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
        drawLanes(cx, cy, isGhost);
        notes.forEach(n => {
            if(n.processed) return;
            const diffHead = n.time - now;
            if(n.duration>0) {
                const diffTail = (n.time+n.duration) - now;
                let rHead = (1-diffHead/travel)*HIT_RADIUS;
                if(n.holding) rHead = HIT_RADIUS; 
                let rTail = (1-diffTail/travel)*HIT_RADIUS;
                if(rHead>0 && rTail<HIT_RADIUS) {
                    let drawStart = Math.max(0, rTail); let drawEnd = Math.min(HIT_RADIUS, rHead);
                    if(drawEnd > drawStart) drawNoteBody(cx, cy, n.lane, drawEnd, drawStart, isGhost);
                    if(rTail > 0 && rTail <= HIT_RADIUS) drawNoteHead(cx, cy, n.lane, rTail, n.isSync, false, isGhost); 
                }
            }
            if(diffHead>travel || n.holding) return;
            const r = (1-diffHead/travel)*HIT_RADIUS;
            if(r>0) drawNoteHead(cx, cy, n.lane, r, n.isSync, false, isGhost);
        });
        if(!isGhost) updateParticles();
    }
    function drawLanes(cx, cy, isGhost) {
        [0,1,2,3].forEach(i => {
            const ang = [-1.57,0,1.57,3.14][i];
            const x = cx+Math.cos(ang)*HIT_RADIUS, y = cy+Math.sin(ang)*HIT_RADIUS;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); 
            ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.stroke();
            ctx.beginPath(); ctx.arc(x,y,18,0,6.28); ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fill();
            ctx.strokeStyle=LANE_COLORS[i]; ctx.lineWidth=3; ctx.stroke();
        });
        ctx.beginPath(); ctx.arc(cx,cy,35,0,6.28); ctx.strokeStyle='rgba(214,0,255,0.4)'; ctx.stroke();
    }
    function drawNoteBody(cx, cy, lane, rHead, rTail, isGhost) {
        const ang = [-1.57,0,1.57,3.14][lane]||0;
        if(lane===4) {
            ctx.beginPath(); ctx.arc(cx, cy, rHead, 0, 6.28); ctx.arc(cx, cy, rTail, 0, 6.28, true); ctx.fillStyle='rgba(214,0,255,0.3)'; ctx.fill();
        } else {
            const x1=cx+Math.cos(ang)*rHead, y1=cy+Math.sin(ang)*rHead;
            const x2=cx+Math.cos(ang)*rTail, y2=cy+Math.sin(ang)*rTail;
            ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.strokeStyle=LANE_COLORS[lane]; ctx.lineWidth=10; ctx.stroke();
        }
    }
    function drawNoteHead(cx, cy, lane, r, isSync, isHolding, isGhost) {
        if (isSync) {
            ctx.beginPath();
            if (lane === 4) ctx.arc(cx, cy, r + 4, 0, 6.28);
            else { const ang = [-1.57,0,1.57,3.14][lane]; const x = cx + Math.cos(ang) * r, y = cy + Math.sin(ang) * r; ctx.arc(x, y, 19, 0, 6.28); }
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.stroke();
        }
        if(lane===4) {
            ctx.beginPath(); ctx.arc(cx,cy,r,0,6.28); ctx.strokeStyle=LANE_COLORS[4]; ctx.lineWidth=6; ctx.stroke();
            if(isHolding) { ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); }
        } else {
            const ang = [-1.57,0,1.57,3.14][lane]; const x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r;
            ctx.beginPath(); ctx.arc(x,y,15,0,6.28); ctx.fillStyle=LANE_COLORS[lane]; ctx.fill();
            if(isHolding) { ctx.fillStyle='#fff'; ctx.fill(); }
        }
    }
    window.addEventListener('keydown', e => {
        if(e.code === 'Escape') {
            if(document.getElementById('image-viewer-overlay').style.display === 'flex') { closeImageViewer(); return; }
            if(document.getElementById('mailbox-overlay').style.display === 'flex') { closeMailbox(); return; }
            if(document.getElementById('settings-overlay').style.display === 'flex') { closeSettings(); return; }
            if(isPlaying) { if(isPaused) startResumeCountdown(); else pauseGame(); } return;
        }
        if (userSettings.devMode || userSettings.autoMode || !isPlaying || isPaused || isCountingDown || e.repeat) return;
        
        const map = userSettings.inputMode === 'wasd' ? KEYS_MAP_WASD : KEYS_MAP_ARROW;
        const lane = map[e.code];

        // å¦‚æœå¼€å¯äº†Spaceè‡ªåŠ¨ï¼Œåˆ™ç¦ç”¨Spaceé”®çš„æ‰‹åŠ¨è§¦å‘ï¼Œé˜²æ­¢å†²çª
        const a = userSettings.autoArrows || {};
        const isArrowAutoLane =
        (lane === 0 && a.up) ||
        (lane === 1 && a.right) ||
        (lane === 2 && a.down) ||
        (lane === 3 && a.left);

        if ((userSettings.autoSpace && lane === 4) || isArrowAutoLane) return;

        if (lane !== undefined) {
            if(e.code==='Space') e.preventDefault();
            const rawTime = audioCtx.currentTime - startTime;
            const now = rawTime - (userSettings.offset / 1000);
            const note = notes.find(n => !n.processed && !n.headHit && n.lane===lane && Math.abs(n.time-now) < JUDGE_TRAP);
            if(note) {
                const diff = note.time - now;
                const absDiff = Math.abs(diff);
                if (absDiff < JUDGE_GOOD) {
                    note.headHit = true;
                    let type = 'good'; 
                    if(absDiff < JUDGE_CRITICAL) type = 'critical'; 
                    else if(absDiff < JUDGE_PERFECT) type = 'perfect';
                    
                    if(note.duration>0) { note.holding = true; handleHit(type, lane); } 
                    else { note.processed = true; handleHit(type, lane); }
                    createExplosion(lane);
                } else if (absDiff < JUDGE_BAD) {
                    note.headHit = true;
                    if(note.duration>0) { note.holding = true; handleHit('bad', lane); }
                    else { note.processed = true; handleHit('bad', lane); }
                    createExplosion(lane); 
                } else { 
                    note.processed = true; handleHit('miss', lane); 
                }
            }
        }
    });
    window.addEventListener('keyup', e => {
        if (userSettings.devMode || userSettings.autoMode || !isPlaying || isPaused || isCountingDown) return;
        const map = userSettings.inputMode === 'wasd' ? KEYS_MAP_WASD : KEYS_MAP_ARROW;
        const lane = map[e.code];

        // å¦‚æœå¼€å¯äº†Spaceè‡ªåŠ¨ï¼Œç¦ç”¨Spaceçš„æ‰‹åŠ¨æ¾å¼€
        const a = userSettings.autoArrows || {};
        const isArrowAutoLane =
        (lane === 0 && a.up) ||
        (lane === 1 && a.right) ||
        (lane === 2 && a.down) ||
        (lane === 3 && a.left);

        if ((userSettings.autoSpace && lane === 4) || isArrowAutoLane) return;

        if(lane!==undefined) {
            const rawTime = audioCtx.currentTime - startTime;
            const now = rawTime - (userSettings.offset / 1000);
            const note = notes.find(n => n.holding && n.lane===lane);
            if(note) {
                note.holding = false; note.processed = true;
                const diff = (note.time + note.duration) - now;
                const absDiff = Math.abs(diff);
                if(absDiff < JUDGE_GOOD) {
                    if(absDiff < JUDGE_CRITICAL) handleHit('critical', lane); 
                    else if(absDiff < JUDGE_PERFECT) handleHit('perfect', lane); 
                    else handleHit('good', lane);
                } else if (absDiff < JUDGE_BAD) {
                    handleHit('bad', lane);
                } else { 
                    handleHit('miss', lane); 
                }
            }
        }
    });

    function handleHit(type, lane) {
        if (type !== 'miss') playHitSound(lane);
        
        let text="", color="#fff", isRainbow=false;
        
        if(type==='miss') { 
            stats.combo=0; stats.miss++; text="MISS"; color="#f05"; 
        } 
        else if (type === 'bad') {
            stats.combo = 0; stats.bad++; let val = totalScoreUnit * 0.2; text = "BAD"; color = "#a300cc"; 
            stats.rawScore += val; stats.score = Math.min(1000000, Math.round(stats.rawScore));
        }
        else {
            stats.combo++; 
            if(stats.combo > stats.maxCombo) stats.maxCombo = stats.combo;
            let val=0;
            if (type === 'auto') { stats.auto++; val = totalScoreUnit; text = "AUTO"; color = "#00ccff"; }
            else if(type==='critical') { stats.critical++; val=totalScoreUnit; text="PERFECT"; isRainbow=true; }
            else if(type==='perfect') { stats.perfect++; val=totalScoreUnit; text="PERFECT"; }
            else { stats.good++; val=totalScoreUnit*0.5; text="GOOD"; color="#fc0"; }
            stats.rawScore += val; stats.score = Math.min(1000000, Math.round(stats.rawScore));
        }
        const cEl = document.getElementById('combo-display');
        cEl.innerText = stats.combo>0 ? "COMBO "+stats.combo : "";
        cEl.style.opacity = stats.combo>0 ? 1 : 0;
        const scorePct = (stats.score / 1000000) * 100;
        const barFill = document.getElementById('score-bar-fill');
        barFill.style.height = scorePct + "%";
        const clearScore = CLEAR_THRESHOLDS[selectedDiff];
        if (stats.score >= clearScore && !barFill.classList.contains('score-bar-cleared')) {
            barFill.classList.add('score-bar-cleared'); document.getElementById('score-bar-marker').classList.add('marker-passed');
        }
        if(lane!==undefined) {
            const pos = getPosFromLane(lane);
            if(type!=='miss') createExplosion(lane); 
            createFloatText(pos.x, pos.y, text, color, isRainbow);
        }
    }
    function createExplosion(lane) {
        const pos = getPosFromLane(lane);
        for(let i=0; i<15; i++) particles.push({ x:pos.x, y:pos.y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1, color:LANE_COLORS[lane], type:'spark'});
    }
    function createFloatText(x, y, t, c, r) { particles.push({ x, y, text:t, color:c, isRainbow:r, life:1, type:'text' }); }
    function getPosFromLane(l) {
        if(l===4) return {x:canvas.width/2, y:canvas.height/2};
        const a = [-1.57,0,1.57,3.14][l];
        return { x:canvas.width/2+Math.cos(a)*HIT_RADIUS, y:canvas.height/2+Math.sin(a)*HIT_RADIUS };
    }
    function updateParticles() {
        for(let i=particles.length-1; i>=0; i--) {
            let p=particles[i];
            
            if(p.type==='spark' || p.type==='firework') {
                p.x += p.vx;
                p.y += p.vy;
                
                if(p.gravity) p.vy += p.gravity;
                
                // å¢åŠ ç©ºæ°”é˜»åŠ›ï¼Œè®©å®ƒç‚¸å¼€åè¿…é€Ÿå‡é€Ÿ
                p.vx *= 0.92; 
                p.vy *= 0.92;

                p.life -= p.decay || 0.05;

                ctx.globalAlpha = Math.max(0, p.life);
                ctx.fillStyle = p.color;
                
                // [ä¿®æ”¹] æ”¹ä¸ºç»˜åˆ¶åœ†å½¢ï¼Œè§†è§‰æ•ˆæœæ›´æŸ”å’Œ
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size || 3, 0, Math.PI * 2);
                ctx.fill();
                
            } else {
                // æ–‡å­—æ¸²æŸ“ä¿æŒä¸å˜
                p.y-=2; p.life-=0.02; ctx.globalAlpha=Math.max(0,p.life);
                ctx.font="900 24px Arial"; ctx.textAlign="center";
                if(p.isRainbow) {
                    const g=ctx.createLinearGradient(p.x-30,p.y,p.x+30,p.y); g.addColorStop(0,"red"); g.addColorStop(1,"violet"); ctx.fillStyle=g;
                } else ctx.fillStyle=p.color;
                ctx.fillText(p.text,p.x,p.y); ctx.strokeStyle="black"; ctx.lineWidth=2; ctx.strokeText(p.text,p.x,p.y);
            }
            if(p.life<=0) particles.splice(i,1);
        }
        ctx.globalAlpha=1;
    }

    function pauseGame() {
        if(isCountingDown) return; isPaused = true; audioCtx.suspend(); document.getElementById('pause-menu').style.display = 'flex';
    }
    function startResumeCountdown() {
        document.getElementById('pause-menu').style.display = 'none'; isCountingDown = true;
        const countEl = document.getElementById('countdown-overlay'); countEl.style.display = 'flex';
        let count = 5; countEl.innerText = count;
        const timer = setInterval(() => {
            count--; if(count > 0) countEl.innerText = count;
            else { clearInterval(timer); countEl.style.display = 'none'; isPaused = false; isCountingDown = false; audioCtx.resume(); gameLoop(); }
        }, 1000);
    }
    window.startResumeCountdown = startResumeCountdown;
    window.resumeGame = startResumeCountdown; 

    window.retryGame = function() {
        if(bgmSource) { try { bgmSource.stop(); } catch(e){} }
        
        isPlaying = false;
        isPaused = false;
        isCountingDown = false;
        
        document.getElementById('pause-menu').style.display = 'none';
        document.getElementById('countdown-overlay').style.display = 'none';
        
        startGame();
    };

    window.backToMenu = function() {
        // [æ–°å¢] æ¸…ç†çƒŸèŠ±å®šæ—¶å™¨å’Œç²’å­
        if (fireworkTimer) { clearInterval(fireworkTimer); fireworkTimer = null; }
        particles = []; 
        // resultRenderLoop ä¼šå› ä¸º display ä¸ä¸º flex è€Œè‡ªåŠ¨åœæ­¢ç»˜åˆ¶ï¼Œä½†æ¸…ç©º particles å¾ˆé‡è¦

        if(bgmSource) {
            try{ bgmSource.stop(); } catch(e){}
            bgmSource.disconnect();
            bgmSource = null;
        }

        if(bgmSource) {
            try{ bgmSource.stop(); } catch(e){}
            bgmSource.disconnect();
            bgmSource = null;
        }
        audioBuffer = null; 
        notes = [];
        events = [];
        particles = [];
        
        isPlaying = false;
        cancelAnimationFrame(animationFrameId);
        
        document.getElementById('pause-menu').style.display='none';
        document.getElementById('hud').style.display='none';
        document.getElementById('result-screen').style.display='none';
        document.getElementById('countdown-overlay').style.display='none';
        document.getElementById('song-select-screen').style.display='flex';
        document.getElementById('loading-overlay').style.display='none'; 
        document.getElementById('bg-layer').style.opacity = 0.5;
        document.getElementById('bg-layer').style.filter = "blur(8px) brightness(0.5)";
        
        previewRequestId++;
        updateRecordDisplay(); 
        if(currentSong) playPreview(currentSong, previewRequestId);
    };

    // --- çƒŸèŠ±ç³»ç»Ÿå˜é‡ä¸å‡½æ•° ---
    let resultInterval = null;
    let fireworkTimer = null;

    // ç»“ç®—ç•Œé¢ä¸“ç”¨çš„æ¸²æŸ“å¾ªç¯
    function resultRenderLoop() {
        if(document.getElementById('result-screen').style.display !== 'flex') return;
        
        // 1. æ­£å¸¸ç»˜åˆ¶åŠé€æ˜é»‘è‰²èƒŒæ™¯ (ç”¨æ¥é®ä½æ¸¸æˆç”»é¢ï¼Œçªå‡ºçƒŸèŠ±)
        // å¿…é¡»å…ˆè®¾ç½®ä¸º source-overï¼Œå¦åˆ™èƒŒæ™¯æ— æ³•æ­£ç¡®è¦†ç›–
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.85)'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 2. [æ ¸å¿ƒä¿®æ”¹] å¼€å¯â€œå˜äº®â€æ··åˆæ¨¡å¼
        // è¿™ä¼šè®©çƒŸèŠ±ç²’å­åœ¨æ·±è‰²èƒŒæ™¯ä¸Šå‘å…‰ï¼Œå¹¶ä¸”é‡å å¤„æ›´äº®
        ctx.globalCompositeOperation = 'lighter';
        
        // 3. ç»˜åˆ¶ç²’å­
        updateParticles();
        
        // 4. æ¢å¤é»˜è®¤æ¨¡å¼ï¼Œä»¥å…å½±å“ä¸‹ä¸€æ¬¡å¾ªç¯çš„èƒŒæ™¯ç»˜åˆ¶
        ctx.globalCompositeOperation = 'source-over';
        
        requestAnimationFrame(resultRenderLoop);
    }

    // ç”ŸæˆçƒŸèŠ±
    function spawnFirework(type) {
        // è®©çƒŸèŠ±ä½ç½®ç¨å¾®é ä¸Šä¸€ç‚¹ï¼Œä¸è¦è¢«åˆ†æ•°æ¿æŒ¡ä½å¤ªå¤š
        const x = Math.random() * canvas.width * 0.6 + canvas.width * 0.2;
        const y = Math.random() * canvas.height * 0.4 + canvas.height * 0.1;
        
        const isRich = type === 'rich'; 
        // [ä¿®æ”¹] å¢åŠ ç²’å­æ•°é‡ï¼šæ™®é€š80ä¸ªï¼Œç»šä¸½200ä¸ª
        const particleCount = isRich ? 200 : 80; 
        const baseColorHue = Math.random() * 360; 

        for (let i = 0; i < particleCount; i++) {
            const angle = Math.random() * Math.PI * 2;
            // [ä¿®æ”¹] æé«˜é€Ÿåº¦èŒƒå›´ï¼Œè®©çˆ†ç‚¸èŒƒå›´æ›´å¤§
            const speed = Math.random() * (isRich ? 12 : 8) + 2; 
            
            let color;
            // [ä¿®æ”¹] è°ƒæ•´ HSL äº®åº¦ (L) ä» 50% æé«˜åˆ° 70%-80%ï¼Œè¿™æ ·çœ‹èµ·æ¥æ›´åƒâ€œå…‰â€è€Œä¸æ˜¯â€œæ¼†â€
            if (isRich) {
                const hue = (baseColorHue + Math.random() * 60) % 360;
                color = `hsl(${hue}, 100%, 75%)`; 
            } else {
                const hue = 30 + Math.random() * 30; // é‡‘è‰²
                color = `hsl(${hue}, 100%, 70%)`;
            }

            particles.push({
                x: x, y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                gravity: 0.1 + Math.random() * 0.05, // [ä¿®æ”¹] ç¨å¾®åŠ é‡é‡åŠ›ï¼Œä¸‹å æ„Ÿæ›´å¼º
                life: 1.2, // [ä¿®æ”¹] ç¨å¾®ç¼©çŸ­å¯¿å‘½ï¼Œé…åˆé«˜äº®åº¦
                decay: Math.random() * 0.01 + 0.015,
                color: color,
                // [ä¿®æ”¹] ç²’å­å˜å¤§ï¼šæ™®é€š 3-6pxï¼Œç»šä¸½ 4-9px
                size: isRich ? Math.random() * 5 + 4 : Math.random() * 3 + 3,
                type: 'firework'
            });
        }
    }

    // å¯åŠ¨çƒŸèŠ±å®šæ—¶å™¨
    function startFireworkShow(type) {
        console.log("å¯åŠ¨çƒŸèŠ±æ•ˆæœ! ç±»å‹:", type); // æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°(F12)çœ‹æœ‰æ²¡æœ‰è¿™å¥è¯
        
        spawnFirework(type);
        const interval = type === 'rich' ? 400 : 800;
        
        if (fireworkTimer) clearInterval(fireworkTimer);
        fireworkTimer = setInterval(() => {
            spawnFirework(type);
        }, interval);
    }

    function finishGame() {
        isPlaying = false;
        cancelAnimationFrame(animationFrameId);
        
        // éšè—HUDï¼Œæ˜¾ç¤ºç»“ç®—ç•Œé¢
        document.getElementById('hud').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        
        const scoreEl = document.getElementById('res-score');
        const newRecordBadge = document.getElementById('new-record-badge');
        
        newRecordBadge.style.display = 'none';

        // è®¾ç½®åˆ†æ•°æ˜¾ç¤º
        if (userSettings.autoMode) {
            scoreEl.innerText = "AUTO"; 
            scoreEl.style.color = "#00ccff";
        } else {
            scoreEl.innerText = stats.score.toString().padStart(7, '0'); 
            scoreEl.style.color = "#fff";
        }

        // è®¾ç½®è¯¦ç»†æ•°æ®
        document.getElementById('res-crit').innerText = userSettings.autoMode ? stats.auto : stats.critical;
        document.getElementById('res-perf').innerText = stats.perfect;
        document.getElementById('res-good').innerText = stats.good;
        document.getElementById('res-bad').innerText = stats.bad;
        document.getElementById('res-miss').innerText = stats.miss;
        document.getElementById('res-maxcombo').innerText = stats.maxCombo;

        // è®¡ç®—ç¢ç‰‡å¥–åŠ±
        let fragmentsEarned = 0;
        if (!userSettings.autoMode && !userSettings.devMode && !isAssistAutoActive()) {
            if (stats.score >= 950000) fragmentsEarned = 50;
            else if (stats.score >= 900000) fragmentsEarned = 40;
            else if (stats.score >= 800000) fragmentsEarned = 30;
            else if (stats.score >= 600000) fragmentsEarned = 10;
            else fragmentsEarned = 5;
            
            if(selectedDiff === 'hard') fragmentsEarned = Math.floor(fragmentsEarned * 1.2);
            if(selectedDiff === 'expert') fragmentsEarned = Math.floor(fragmentsEarned * 1.5);
            
            if(stats.miss===0 && stats.bad===0) fragmentsEarned += 10;
            if(stats.good===0 && stats.miss===0 && stats.bad===0) fragmentsEarned += 20;

            playerInventory.fragments += fragmentsEarned;
            saveInventory();
        } else {
            fragmentsEarned = 0;
        }
        document.getElementById('res-fragments-earned').innerText = fragmentsEarned;

        // åˆ¤æ–­æ˜¯å¦ Clear
        const threshold = CLEAR_THRESHOLDS[selectedDiff] || 600000;
        let isCleared = stats.score >= threshold;
        const msg = document.getElementById('failed-msg');

        if (!isCleared && !userSettings.autoMode) {
            msg.innerText = "CHALLENGE FAILED"; msg.style.display = 'block';
        } else {
            msg.style.display = 'none';
        }
        
        // --- å°ç«  (Stamp) ä¸ çƒŸèŠ±åˆ¤å®šé€»è¾‘ ---
        const area = document.getElementById('stamp-area');
        area.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å°ç« 
        const d = document.createElement('div'); // åˆ›å»ºæ–°å°ç« å…ƒç´ 

        let clearType = CLEAR_TYPE.NONE;
        if (isCleared) clearType = CLEAR_TYPE.CLEAR;

        if (userSettings.autoMode) {
            d.innerText = "AUTO MODE"; 
            d.className = "stamp-auto"; 
            area.appendChild(d); // å¿…é¡»æ·»åŠ è¿› DOM
        } else {
            // åˆ¤å®š AC / AP / FC
            if(stats.miss === 0 && stats.bad === 0) {
                if (stats.good === 0 && stats.perfect === 0) {
                    // All Critical
                    d.innerText = "ALL CRITICAL"; 
                    d.className = "stamp-critical";
                    clearType = CLEAR_TYPE.AC;
                } else {
                    d.className = "stamp-normal";
                    if (stats.good === 0) {
                        // All Perfect
                        d.innerText = "ALL PERFECT"; 
                        d.style.color = "#0ff";
                        clearType = CLEAR_TYPE.AP;
                    } else {
                        // Full Combo
                        d.innerText = "FULL COMBO"; 
                        d.style.color = "#fc0";
                        clearType = CLEAR_TYPE.FC;
                    }
                }
                // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿å°ç« è¢«æ·»åŠ åˆ°é¡µé¢ä¸Š
                area.appendChild(d);
            }

            // ä¿å­˜è®°å½•é€»è¾‘
            const currentKey = `${currentSong.id}_${selectedDiff}`;
            const savedData = loadRecords()[currentKey];
            const oldScore = savedData ? savedData.score : 0;

            if (stats.score > oldScore) {
                newRecordBadge.style.display = 'block'; 
            }
            saveRecord(currentSong.id, selectedDiff, stats.score, clearType);
        }
        
        // è®¾ç½®è¯„çº§ (S, A, B...)
        let grade='F', color='#888';
        if(stats.score>=950000) { grade='S'; color='#d600ff'; }
        else if(stats.score>=900000) { grade='A'; color='#0ff'; }
        else if(stats.score>=800000) { grade='B'; color='#0f0'; }
        else if(stats.score>=600000) { grade='C'; color='#ff0'; }
        
        const gEl = document.getElementById('res-grade');
        gEl.innerText = grade; 
        gEl.style.color = color;

        // --- è§¦å‘çƒŸèŠ±é€»è¾‘ ---
        // 1. å¯åŠ¨ç»“ç®—ç•Œé¢çš„ Canvas æ¸²æŸ“å¾ªç¯
        resultRenderLoop();

        // 2. åªæœ‰éè‡ªåŠ¨æ¨¡å¼ä¸”è¾¾æˆ FC/AP/AC æ—¶æ‰æ”¾çƒŸèŠ±
        if (!userSettings.autoMode && !isAssistAutoActive()) {
            if (clearType === CLEAR_TYPE.AC || clearType === CLEAR_TYPE.AP) {
                startFireworkShow('rich'); // ç»šä¸½çƒŸèŠ±
            } else if (clearType === CLEAR_TYPE.FC) {
                startFireworkShow('normal'); // æ™®é€šçƒŸèŠ±
            }
        }
    }

    const CURRENT_VERSION_KEY = 'V1.4.0_alpha';
    function checkUpdatePopup() { if (!localStorage.getItem(CURRENT_VERSION_KEY)) document.getElementById('update-modal').style.display = 'flex'; }
    window.closeUpdateModal = function() {
        document.getElementById('update-modal').style.display = 'none';
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        previewRequestId++; playPreview(currentSong, previewRequestId);
        localStorage.setItem(CURRENT_VERSION_KEY, 'true');
    };

    let isCalibrating = false;
    let calibTapHistory = [], calibNextBeatTime = 0, calibIntervalId;
    const CALIB_BPM = 100, CALIB_INTERVAL = 60 / CALIB_BPM, TOTAL_TAPS_NEEDED = 8;
    function startCalibration() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isCalibrating = true; calibTapHistory = [];
        document.getElementById('calibration-overlay').style.display = 'flex';
        document.getElementById('calib-step-1').style.display = 'block';
        document.getElementById('calib-result').style.display = 'none';
        document.getElementById('calib-apply-btn').style.display = 'none';
        document.getElementById('calib-progress-bar').style.width = '0%';
        document.getElementById('calib-status').innerText = "Listen to the beat...";
        stopPreview();
        calibNextBeatTime = audioCtx.currentTime + 0.5;
        playCalibBeatLoop();
    }
    function stopCalibration() {
        isCalibrating = false; clearTimeout(calibIntervalId);
        document.getElementById('calibration-overlay').style.display = 'none';
        previewRequestId++; playPreview(currentSong, previewRequestId);
    }
    function playCalibBeatLoop() {
        if (!isCalibrating) return;
        const currentTime = audioCtx.currentTime;
        if (currentTime >= calibNextBeatTime - 0.05) {
            playCalibSound(calibNextBeatTime);
            const delay = Math.max(0, (calibNextBeatTime - currentTime) * 1000);
            setTimeout(() => {
                if(!isCalibrating) return;
                const circle = document.getElementById('calib-beat-circle');
                circle.classList.add('beat-active');
                setTimeout(() => circle.classList.remove('beat-active'), 100);
            }, delay);
            calibNextBeatTime += CALIB_INTERVAL;
        }
        calibIntervalId = setTimeout(playCalibBeatLoop, 20);
    }
    function playCalibSound(time) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(880, time); osc.type = 'triangle';
        gain.gain.setValueAtTime(0, time); gain.gain.linearRampToValueAtTime(0.5, time + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
        osc.start(time); osc.stop(time + 0.1);
    }
    function handleCalibInput() {
        if (!isCalibrating || calibTapHistory.length >= TOTAL_TAPS_NEEDED) return;
        const now = audioCtx.currentTime;
        const diffPrev = now - (calibNextBeatTime - CALIB_INTERVAL); const diffNext = calibNextBeatTime - now; 
        let offset = (now - ((diffPrev < diffNext) ? (calibNextBeatTime - CALIB_INTERVAL) : calibNextBeatTime)) * 1000;
        const circle = document.getElementById('calib-beat-circle');
        circle.classList.remove('beat-active'); void circle.offsetWidth; circle.classList.add('tap-feedback');
        setTimeout(() => circle.classList.remove('tap-feedback'), 100);
        calibTapHistory.push(offset);
        document.getElementById('calib-progress-bar').style.width = (calibTapHistory.length / TOTAL_TAPS_NEEDED * 100) + "%";
        document.getElementById('calib-status').innerText = `Recording... ${calibTapHistory.length}/${TOTAL_TAPS_NEEDED}`;
        if (calibTapHistory.length >= TOTAL_TAPS_NEEDED) finishCalibration();
    }
    function calculateAverage(arr) {
        if (arr.length > 4) { arr.sort((a,b) => a-b); arr = arr.slice(1, arr.length-1); }
        return Math.floor(arr.reduce((a, b) => a + b, 0) / arr.length);
    }
    function finishCalibration() {
        isCalibrating = false; clearTimeout(calibIntervalId);
        const finalOffset = calculateAverage(calibTapHistory);
        document.getElementById('calib-status').innerText = "Calculation Complete";
        document.getElementById('calib-result').style.display = 'block';
        document.getElementById('calib-result').innerText = `Recommended Offset: ${finalOffset} ms`;
        const applyBtn = document.getElementById('calib-apply-btn');
        applyBtn.style.display = 'inline-block'; applyBtn.dataset.offset = finalOffset;
    }
    function applyCalibration() {
        const val = parseInt(document.getElementById('calib-apply-btn').dataset.offset);
        userSettings.offset = val; document.getElementById('offset-input').value = val; saveSettings();
        alert(`å·²åº”ç”¨å»¶è¿Ÿ: ${val}ms`); stopCalibration();
    }
    window.addEventListener('keydown', e => { if (isCalibrating && (e.code === 'Space' || e.code.startsWith('Arrow') || e.code.startsWith('Key'))) handleCalibInput(); });
    document.getElementById('calibration-overlay').addEventListener('mousedown', (e) => { if(e.target.tagName !== 'BUTTON') handleCalibInput(); });
</script>
</body>
</html>